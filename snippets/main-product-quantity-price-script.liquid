<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log("CacoAmerica: Quantity Price Script Loaded");
    
    // We bind to the section but search looser if needed
    const sectionId = '{{ section.id }}';
    
    // Attempt to find key elements
    function findElements() {
        const qtyInput = document.getElementById(`Quantity-${sectionId}`) || document.querySelector(`[id^="Quantity-"][data-section="${sectionId}"]`);
        
        let btn = document.getElementById(`ProductSubmitButton-${sectionId}`);
        if (!btn) {
            // Fallback: search essentially for the main add to cart button in this section's product form
            const forms = document.querySelectorAll(`product-form[data-section-id="${sectionId}"] form, form[action*="/cart/add"]`);
            for (let f of forms) {
                const b = f.querySelector('[type="submit"][name="add"]');
                if (b) { btn = b; break; }
            }
        }
        
        return { qtyInput, btn };
    }

    const { qtyInput, btn } = findElements();
    
    if (!qtyInput || !btn) {
        console.warn("CacoAmerica: Missing Qty Input or Button. Aborting.");
        return;
    }
    
    const btnSpan = btn.querySelector('span') || btn;

    // Data Source
    function getVariantPrice(vid) {
        // Source 1: The new robust script
        const s1 = document.getElementById(`ProductPrices-${sectionId}`);
        if (s1) {
            try {
                const data = JSON.parse(s1.textContent);
                if (data[vid]) {
                     // Check subscription
                     const subRadio = document.querySelector(`input[name="purchase_option"][value="subscription"]:checked`);
                     return subRadio ? data[vid].subscription : data[vid].price;
                }
            } catch(e) {}
        }
        // Source 2: Legacy/Theme data?
        const s2 = document.getElementById(`VariantSubscription-${sectionId}`);
        if (s2) {
             try {
                const data = JSON.parse(s2.textContent);
                if (data[vid]) {
                     // Check subscription
                     const subRadio = document.querySelector(`input[name="purchase_option"][value="subscription"]:checked`);
                     return subRadio ? data[vid].subscription : data[vid].onetime;
                }
            } catch(e) {}
        }
        
        return null;
    }
    
     // Robust Money Formatter
    function formatMoney(cents, format) {
      if (typeof cents === 'string') cents = cents.replace('.', '');
      let value = '';
      const placeholderRegex = /\{\{\s*(\w+)\s*\}\}/;
      const formatString = format || '{{amount}}';

      function defaultOption(opt, def) {
        return (typeof opt == 'undefined' ? def : opt);
      }

      function formatWithDelimiters(number, precision, thousands, decimal) {
        precision = defaultOption(precision, 2);
        thousands = defaultOption(thousands, ',');
        decimal = defaultOption(decimal, '.');

        if (isNaN(number) || number == null) { return 0; }

        number = (number / 100).toFixed(precision);

        var parts = number.split('.');
        var dollars = parts[0].replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1' + thousands);
        var cents = parts[1] ? (decimal + parts[1]) : '';

        return dollars + cents;
      }

      const match = formatString.match(placeholderRegex);
      if (!match) return '$' + (cents/100).toFixed(2); 

      switch(match[1]) {
        case 'amount':
          value = formatWithDelimiters(cents, 2);
          break;
        case 'amount_no_decimals':
          value = formatWithDelimiters(cents, 0);
          break;
        case 'amount_with_comma_separator':
          value = formatWithDelimiters(cents, 2, '.', ',');
          break;
        case 'amount_no_decimals_with_comma_separator':
          value = formatWithDelimiters(cents, 0, '.', ',');
          break;
        default:
          value = formatWithDelimiters(cents, 2);
      }

      return formatString.replace(placeholderRegex, value);
    }
    
    const moneyFormat = {{ shop.money_format | json }};
    // Save original text once
    const originalText = btnSpan.textContent.trim().split(' - ')[0] || {{ 'products.product.add_to_cart' | t | json }};
    
    let isInternalUpdate = false;

    function update() {
        if (isInternalUpdate) return;
        
        // Find current variant ID
        let vid = '{{ product.selected_or_first_available_variant.id }}';
        const form = btn.closest('form');
        if (form) {
            const i = form.querySelector('input[name="id"]');
            if (i) vid = i.value;
        }
        
        const qty = parseInt(qtyInput.value) || 1;
        
        if (qty <= 1) {
             // Revert
             // Only revert if we messed it up
             if (btnSpan.textContent.includes(' - ')) {
                 isInternalUpdate = true;
                 btnSpan.textContent = originalText;
                 isInternalUpdate = false;
             }
             return;
        }
        
        // Calculate
        const price = getVariantPrice(vid);
        if (price === null) return;
        
        const total = price * qty;
        const totalFormatted = formatMoney(total, moneyFormat);
        
        const newText = `${originalText} - ${totalFormatted}`;
        
        if (btnSpan.textContent !== newText) {
             isInternalUpdate = true;
             btnSpan.textContent = newText;
             isInternalUpdate = false;
        }
    }
    
    // Observers
    const obs = new MutationObserver(() => update());
    obs.observe(btnSpan, { childList: true, characterData: true, subtree: true });
    
    // Listeners
    qtyInput.addEventListener('input', update);
    qtyInput.addEventListener('change', update);
    
    // Helper for buttons around input
    document.querySelectorAll('quantity-input button').forEach(b => b.addEventListener('click', () => setTimeout(update, 50)));
    
    document.addEventListener('variant:change', () => setTimeout(update, 100));
    document.querySelectorAll('input[name="purchase_option"]').forEach(r => r.addEventListener('change', update));
    
    // Init
    update();
  });
</script>
