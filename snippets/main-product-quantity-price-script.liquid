<script>
  document.addEventListener('DOMContentLoaded', function() {
    const sectionId = '{{ section.id }}';
    const formId = 'product-form-' + sectionId;
    const qtyInput = document.getElementById(`Quantity-${sectionId}`);
    
    if (!qtyInput) return;

    // Robust Money Formatter
    function formatMoney(cents, format) {
      if (typeof cents === 'string') cents = cents.replace('.', '');
      let value = '';
      const placeholderRegex = /\{\{\s*(\w+)\s*\}\}/;
      const formatString = format || '{{amount}}';

      function defaultOption(opt, def) {
        return (typeof opt == 'undefined' ? def : opt);
      }

      function formatWithDelimiters(number, precision, thousands, decimal) {
        precision = defaultOption(precision, 2);
        thousands = defaultOption(thousands, ',');
        decimal = defaultOption(decimal, '.');

        if (isNaN(number) || number == null) { return 0; }

        number = (number / 100).toFixed(precision);

        var parts = number.split('.');
        var dollars = parts[0].replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1' + thousands);
        var cents = parts[1] ? (decimal + parts[1]) : '';

        return dollars + cents;
      }

      const match = formatString.match(placeholderRegex);
      if (!match) return '$' + (cents/100).toFixed(2); 

      switch(match[1]) {
        case 'amount':
          value = formatWithDelimiters(cents, 2);
          break;
        case 'amount_no_decimals':
          value = formatWithDelimiters(cents, 0);
          break;
        case 'amount_with_comma_separator':
          value = formatWithDelimiters(cents, 2, '.', ',');
          break;
        case 'amount_no_decimals_with_comma_separator':
          value = formatWithDelimiters(cents, 0, '.', ',');
          break;
        default:
          value = formatWithDelimiters(cents, 2);
      }

      return formatString.replace(placeholderRegex, value);
    }

    const defaultText = {{ 'products.product.add_to_cart' | t | json }};
    const moneyFormat = {{ shop.money_format | json }};
    
    let isUpdating = false;

    function getAttributes() {
        const btn = document.getElementById(`ProductSubmitButton-${sectionId}`);
        if (!btn) return null;
        const span = btn.querySelector('span');
        return { btn, span };
    }

    function calculateTotal() {
        // Get pricing data
        const internalDataScript = document.getElementById(`VariantSubscription-${sectionId}`);
        let variantData = null;
        try {
            if (internalDataScript) variantData = JSON.parse(internalDataScript.textContent);
        } catch(e) {}

        // Variant ID
        const productForm = document.getElementById(formId);
        let currentVariantId = '{{ product.selected_or_first_available_variant.id }}';
        if (productForm) {
            const variantInput = productForm.querySelector('input[name="id"]');
            if (variantInput) currentVariantId = variantInput.value;
        }

        // Qty
        const qty = parseInt(qtyInput.value) || 1;

        // Base Price
        let basePrice = 0;
        if (variantData && variantData[currentVariantId]) {
            const data = variantData[currentVariantId];
            const subRadio = document.querySelector(`input[name="purchase_option"][value="subscription"]`);
            const isSub = subRadio && subRadio.checked;
            basePrice = isSub ? data.subscription : data.onetime;
        }

        return { qty, total: basePrice * qty };
    }

    function updateAddToCartButton() {
        if (isUpdating) return;
        
        const { btn, span } = getAttributes() || {};
        if (!btn || !span || btn.hasAttribute('disabled')) return;

        const { qty, total } = calculateTotal();

        isUpdating = true;
        
        // Logic: Only change text if Qty > 1 AND text needs update
        if (qty <= 1) {
             // Let theme handle singular or we reset if needed, but best not to interfere too much
             // If we want to strictly reset:
             if (span.textContent.includes(' - ')) {
                 span.textContent = defaultText;
             }
        } else {
            const formattedTotal = formatMoney(total, moneyFormat);
            const newText = `${defaultText} - ${formattedTotal}`;
            if (span.textContent !== newText) {
                span.textContent = newText;
            }
        }
        
        isUpdating = false;
    }

    // Observer to fight race conditions
    const { span } = getAttributes() || {};
    if (span) {
        const observer = new MutationObserver(() => {
            if (!isUpdating) updateAddToCartButton();
        });
        observer.observe(span, { childList: true, characterData: true, subtree: true });
    }

    // Event Listeners
    qtyInput.addEventListener('input', updateAddToCartButton);
    qtyInput.addEventListener('change', updateAddToCartButton);
    
    // Buttons
    const wrapper = qtyInput.closest('quantity-input');
    if (wrapper) {
        wrapper.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', () => setTimeout(updateAddToCartButton, 50));
        });
    }

    const radios = document.querySelectorAll(`input[name="purchase_option"]`);
    radios.forEach(r => r.addEventListener('change', updateAddToCartButton));
    
    document.addEventListener('variant:change', () => setTimeout(updateAddToCartButton, 100));
    
    // Initial Run
    updateAddToCartButton();
  });
</script>
