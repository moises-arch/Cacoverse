{% comment %}
  Product Video Hub Component - Source: Metafields (Underscore Notation)
  Displays a single entry point "Video Tile" that opens a dedicated video lightbox with playlist.
  Supports Metaobjects or specific video metafields using underscore notation for fields.
  Updated for Shopify Sync.
{% endcomment %}

{%- liquid
  assign video_data = nil
  
  # Try to get videos from Metaobject list
  if product.metafields.custom.video_hub.value
    assign video_data = product.metafields.custom.video_hub.value
  elsif product.metafields.custom.video_json.value
    assign video_data = product.metafields.custom.video_json.value
  endif
-%}

{%- if video_data.size > 0 or video_data != nil -%}
  {{ 'product-video-hub.css' | asset_url | stylesheet_tag }}

  {%- liquid
    # Sort by sort_order if available, otherwise respect list order
    assign sorted_videos = video_data | sort: 'sort_order'
    
    assign featured_video = nil
    for vid in sorted_videos
      if vid.custom_featured == true or vid.custom_featured.value == true
        assign featured_video = vid
        break
      endif
    endfor
    
    if featured_video == nil
      assign featured_video = sorted_videos[0]
    endif
    
    assign total_videos = sorted_videos.size
  -%}

  <div class="product-video-hub-container" id="productVideoHubTile">
    <button type="button" class="video-hub-tile" aria-label="Open video gallery" data-video-hub-opener>
      <div class="video-hub-tile__wrapper">
        {%- liquid
          assign thumb = nil
          
          # 1. Direct thumbnail field (Image/File)
          if featured_video.thumbnail_url or featured_video.thumbnail
            assign thumb = featured_video.thumbnail_url | default: featured_video.thumbnail | image_url: width: 400
          
          # 2. Derive from Video File reference
          elsif featured_video.video_file.preview_image
            assign thumb = featured_video.video_file.preview_image | image_url: width: 400
          
          # 3. Derive from YouTube URL
          elsif featured_video.videos_url contains 'youtube.com' or featured_video.videos_url contains 'youtu.be'
            assign yt_id = featured_video.videos_url | split: 'v=' | last | split: '&' | first | split: '/' | last
            assign thumb = 'https://img.youtube.com/vi/' | append: yt_id | append: '/hqdefault.jpg'
          endif
        -%}

        {%- if thumb != nil -%}
          <img src="{{ thumb }}" alt="{{ featured_video.short_title | default: featured_video.title | escape }}" loading="lazy" class="video-hub-tile__img">
        {%- else -%}
          <div class="video-hub-tile__placeholder">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M15 10l5 5-5 5v-4H4v-2h11v-4z"/></svg>
          </div>
        {%- endif -%}
        
        <div class="video-hub-tile__overlay">
          <div class="video-hub-tile__play-icon">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5.14v13.72l11-6.86 -11-6.86z"/></svg>
          </div>
          
          {%- if total_videos > 1 -%}
            <div class="video-hub-tile__badge">
              <span>{{ total_videos }}</span>
            </div>
          {%- endif -%}
          
          <div class="video-hub-tile__label">
            <span>VIDEO{% if total_videos > 1 %}S{% endif %}</span>
          </div>
        </div>
      </div>
    </button>
  </div>

  <!-- Video Lightbox Modal -->
  <div id="productVideoLightbox" class="video-lightbox" hidden aria-modal="true" role="dialog">
    <div class="video-lightbox__backdrop"></div>
    
    <div class="video-lightbox__container">
      <button type="button" class="video-lightbox__close" aria-label="Close video player" data-video-lightbox-close>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>

      <div class="video-lightbox__content">
        <!-- Main Player Area -->
        <div class="video-lightbox__player-side">
          <div class="video-lightbox__player-wrapper">
            <div id="videoMainPlayer" class="video-lightbox__player">
              <div class="video-lightbox__loading-indicator">
                <div class="video-player-loader"></div>
              </div>
            </div>
          </div>
          <div class="video-lightbox__video-info">
            <h2 id="videoDisplayTitle" class="video-lightbox__title"></h2>
          </div>
        </div>

        <!-- Playlist Area -->
        <div class="video-lightbox__playlist-side">
          <h3 class="video-lightbox__playlist-header">{{ 'Videos' | escape }} ({{ total_videos }})</h3>
          <div class="video-lightbox__playlist-items" role="listbox">
            {%- for vid in sorted_videos -%}
              {%- liquid
                assign v_id = forloop.index0
                assign v_title = vid.short_title | default: vid.title | escape
                
                # Determine URL and Type
                assign v_url = nil
                assign v_type = 'native'
                
                if vid.video_file
                  # File Object (Video picker)
                  assign v_url = vid.video_file.sources | where: 'format', 'mp4' | first | attr: 'url'
                  if v_url == nil
                    assign v_url = vid.video_file.sources[0].url
                  endif
                elsif vid.videos_url != blank
                  # Text URL
                  assign v_url = vid.videos_url
                  if v_url contains 'youtube.com' or v_url contains 'youtu.be'
                    assign v_type = 'youtube'
                  elsif v_url contains 'vimeo.com'
                    assign v_type = 'vimeo'
                  endif
                endif

                # Determine Thumbnail
                assign v_thumb = nil
                if vid.thumbnail_url or vid.thumbnail
                  assign v_thumb = vid.thumbnail_url | default: vid.thumbnail | image_url: width: 200
                elsif vid.video_file.preview_image
                  assign v_thumb = vid.video_file.preview_image | image_url: width: 200
                elsif v_url contains 'youtube.com' or v_url contains 'youtu.be'
                  assign yt_thumb_id = v_url | split: 'v=' | last | split: '&' | first | split: '/' | last
                  assign v_thumb = 'https://img.youtube.com/vi/' | append: yt_thumb_id | append: '/hqdefault.jpg'
                endif
              -%}
              <button type="button" 
                class="video-playlist-item {% if forloop.first %}is-active{% endif %}" 
                role="option"
                aria-selected="{% if forloop.first %}true{% else %}false{% endif %}"
                data-video-index="{{ v_id }}"
                data-video-url="{{ v_url }}"
                data-video-type="{{ v_type }}"
                data-video-title="{{ v_title }}">
                <div class="video-playlist-item__thumb">
                  {%- if v_thumb != nil -%}
                    <img src="{{ v_thumb }}" alt="{{ v_title }}" loading="lazy">
                  {%- endif -%}
                  <div class="video-playlist-item__play-overlay">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5.14v13.72l11-6.86 -11-6.86z"/></svg>
                  </div>
                </div>
                <div class="video-playlist-item__info">
                  <span class="video-playlist-item__title">{{ v_title }}</span>
                  {%- if vid.duration -%}
                    <span class="video-playlist-item__duration">{{ vid.duration }}</span>
                  {%- endif -%}
                </div>
              </button>
            {%- endfor -%}
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="{{ 'product-video-hub.js' | asset_url }}" defer="defer"></script>
{%- endif -%}
