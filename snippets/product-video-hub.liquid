{% comment %}
  Product Video Hub Component - Source: Native Product Media
  Displays a single entry point "Video Tile" that opens a dedicated video lightbox with playlist.
  This version pulls videos directly from the product's media gallery.
{% endcomment %}

{%- liquid
  assign media_videos = product.media | where: 'media_type', 'video'
  assign external_videos = product.media | where: 'media_type', 'external_video'
  
  # Combine and sort by position (Shopify default)
  # We'll just loop through all media and pick the videos to maintain exact order
  assign video_count = 0
  for media in product.media
    if media.media_type == 'video' or media.media_type == 'external_video'
      assign video_count = video_count | plus: 1
    endif
  endfor
-%}

{%- if video_count > 0 -%}
  {{ 'product-video-hub.css' | asset_url | stylesheet_tag }}

  {%- liquid
    # Find the featured video (first video in media list to respect Shopify order)
    assign featured_video = nil
    for media in product.media
      if media.media_type == 'video' or media.media_type == 'external_video'
        assign featured_video = media
        break
      endif
    endfor
  -%}

  <div class="product-video-hub-container" id="productVideoHubTile">
    <button type="button" class="video-hub-tile" aria-label="Open video gallery" data-video-hub-opener>
      <div class="video-hub-tile__wrapper">
        {%- liquid
          assign thumb = nil
          if featured_video.preview_image
            assign thumb = featured_video.preview_image | image_url: width: 400
          endif
        -%}

        {%- if thumb != nil -%}
          <img src="{{ thumb }}" alt="{{ featured_video.alt | default: product.title | escape }}" loading="lazy" class="video-hub-tile__img">
        {%- else -%}
          <div class="video-hub-tile__placeholder">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M15 10l5 5-5 5v-4H4v-2h11v-4z"/></svg>
          </div>
        {%- endif -%}
        
        <div class="video-hub-tile__overlay">
          <div class="video-hub-tile__play-icon">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5.14v13.72l11-6.86 -11-6.86z"/></svg>
          </div>
          
          {%- if video_count > 1 -%}
            <div class="video-hub-tile__badge">
              <span>{{ video_count }}</span>
            </div>
          {%- endif -%}
          
          <div class="video-hub-tile__label">
            <span>VIDEO{% if video_count > 1 %}S{% endif %}</span>
          </div>
        </div>
      </div>
    </button>
  </div>

  <!-- Video Lightbox Modal -->
  <div id="productVideoLightbox" class="video-lightbox" hidden aria-modal="true" role="dialog">
    <div class="video-lightbox__backdrop"></div>
    
    <div class="video-lightbox__container">
      <button type="button" class="video-lightbox__close" aria-label="Close video player" data-video-lightbox-close>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>

      <div class="video-lightbox__content">
        <!-- Main Player Area -->
        <div class="video-lightbox__player-side">
          <div class="video-lightbox__player-wrapper">
            <div id="videoMainPlayer" class="video-lightbox__player">
              <div class="video-lightbox__loading-indicator">
                <div class="video-player-loader"></div>
              </div>
            </div>
          </div>
          <div class="video-lightbox__video-info">
            <h2 id="videoDisplayTitle" class="video-lightbox__title"></h2>
          </div>
        </div>

        <!-- Playlist Area -->
        <div class="video-lightbox__playlist-side">
          <h3 class="video-lightbox__playlist-header">{{ 'Videos' | escape }} ({{ video_count }})</h3>
          <div class="video-lightbox__playlist-items" role="listbox">
            {%- assign v_index = 0 -%}
            {%- for media in product.media -%}
              {%- if media.media_type == 'video' or media.media_type == 'external_video' -%}
                {%- liquid
                  assign v_title = media.alt | default: product.title | escape
                  if v_title contains '|'
                    assign v_title = v_title | split: '|' | last | strip
                  endif
                  
                  assign v_thumb = media.preview_image | image_url: width: 200
                  
                  # Handle URL and Type
                  if media.media_type == 'video'
                    assign v_url = media.sources | where: 'format', 'mp4' | first | attr: 'url'
                    if v_url == nil
                        assign v_url = media.sources[0].url
                    endif
                    assign v_type = 'native'
                  else
                    assign v_url = media.external_id
                    assign v_type = media.host # youtube or vimeo
                  endif
                -%}
                <button type="button" 
                  class="video-playlist-item {% if v_index == 0 %}is-active{% endif %}" 
                  role="option"
                  aria-selected="{% if v_index == 0 %}true{% else %}false{% endif %}"
                  data-video-index="{{ v_index }}"
                  data-video-url="{{ v_url }}"
                  data-video-type="{{ v_type }}"
                  data-video-title="{{ v_title }}">
                  <div class="video-playlist-item__thumb">
                    {%- if v_thumb != nil -%}
                      <img src="{{ v_thumb }}" alt="{{ v_title }}" loading="lazy">
                    {%- endif -%}
                    <div class="video-playlist-item__play-overlay">
                      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5.14v13.72l11-6.86 -11-6.86z"/></svg>
                    </div>
                  </div>
                  <div class="video-playlist-item__info">
                    <span class="video-playlist-item__title">{{ v_title }}</span>
                  </div>
                </button>
                {%- assign v_index = v_index | plus: 1 -%}
              {%- endif -%}
            {%- endfor -%}
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="{{ 'product-video-hub.js' | asset_url }}" defer="defer"></script>
{%- endif -%}
