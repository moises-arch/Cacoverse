{% comment %}
  Renders a product card

  Accepts:
  - product: {Object} Product Liquid object (optional)

  Usage:
  {% render 'card-product', show_vendor: section.settings.show_vendor %}
{% endcomment %}

{%- liquid
  assign discounted_variants = '' | split: '' 
  assign first_available_discount_variant = nil
  assign first_discount_variant = nil

  for variant in product.variants
    if variant.compare_at_price > variant.price
      assign discounted_variants = discounted_variants | push: variant

      if first_discount_variant == nil
        assign first_discount_variant = variant
      endif

      if first_available_discount_variant == nil and variant.available
        assign first_available_discount_variant = variant
      endif
    endif
  endfor

  assign featured_variant = first_available_discount_variant | default: first_discount_variant | default: product.selected_or_first_available_variant
  assign featured_image = featured_variant.featured_image | default: product.featured_image
  assign featured_url = featured_variant.url | default: product.url
  assign has_discounted_variants = discounted_variants.size > 0
  assign badge_limit = 3
-%}

<div class="card-wraper d-flex flex-column gap-2">
  <div class="card-media" onclick="location.href = '{{ featured_url }}';">
    <a href="{{ featured_url }}">
      <div class="loader" data-product-id="{{ product.id }}"></div>
      <img
        src="{{ featured_image.src | img_url : '500x' }}"
        class="img-fluid product-image"
        loading="lazy"
        width="{{ featured_image.width }}"
        height="{{ featured_image.height }}"
        alt="{{ featured_image.alt | default: product.title }}"
        data-product-id="{{ product.id }}"
      >
    </a>
  </div>

  <div class="descp">
    <p class="sp-20">
      <a href="{{ featured_url }}">{{ product.title }}</a>
    </p>
    <p class="sp-14">{{ product.metafields.custom.sub_title }}</p>
    {% if has_discounted_variants and featured_variant.sku != blank %}
      <p class="sp-12 product-card__sku">
        SKU: {{ featured_variant.sku }}
      </p>
    {% endif %}
  </div>






    {% render 'junip-product-summary', product: product %}






    
  <div class="card__badge {{ settings.badge_position }}">
    {%- if product.available == false -%}
      <span
        id="NoMediaStandardBadge-{{ section_id }}-{{ product.id }}"
        class="badge badge--bottom-left color-{{ settings.sold_out_badge_color_scheme }}"
      >
        {{- 'products.product.sold_out' | t -}}
        
      </span>
    {%- elsif has_discounted_variants and product.available -%}
      <span
        id="NoMediaStandardBadge-{{ section_id }}-{{ product.id }}"
        class="badge badge--bottom-left color-{{ settings.sale_badge_color_scheme }}"
      >
        {{- 'products.product.on_sale' | t -}}
      </span>
    {%- endif -%}
  </div>

  <!-- Pricing -->
  <div class="product-card__price-row">
    {% if has_discounted_variants %}
      {% render 'price',
        product: product,
        target_variant: featured_variant,
        use_variant: true,
        price_class: '',
        show_compare_at_price: true
      %}
    {% else %}
      {% render 'price', product: product, price_class: '', show_compare_at_price: true %}
    {% endif %}

    {% if has_discounted_variants %}
      <div class="product-card__discount-badges" aria-label="Variantes en descuento">
        {% assign hidden_tooltip = '' %}
        {% for variant in discounted_variants %}
          {% assign discount_amount = variant.compare_at_price | minus: variant.price %}
          {% assign discount_percent = discount_amount | times: 100 | divided_by: variant.compare_at_price | round %}
          {% assign tooltip_copy = 'Ahorra ' | append: discount_percent | append: '% en ' | append: variant.title %}

          {% if forloop.index0 < badge_limit %}
            <span class="product-card__discount-badge" data-tooltip="{{ tooltip_copy | escape }}">
              {{- variant.title | replace: '/', ' · ' -}}
            </span>
          {% else %}
            {% assign hidden_tooltip = hidden_tooltip | append: variant.title %}
            {% unless forloop.last %}
              {% assign hidden_tooltip = hidden_tooltip | append: ' • ' %}
            {% endunless %}
          {% endif %}
        {% endfor %}

        {% if discounted_variants.size > badge_limit %}
          {% assign remaining = discounted_variants.size | minus: badge_limit %}
          <span
            class="product-card__discount-badge product-card__discount-badge--more"
            data-tooltip="{{ hidden_tooltip | escape }}"
          >
            +{{ remaining }}
          </span>
        {% endif %}
      </div>
    {% endif %}
  </div>
  {% assign has_color = false %}
  {% assign has_series = false %}

  {% for option in product.options_with_values %}
    {% if option.name == 'Color' %}
      {% assign has_color = true %}
    {% elsif option.name == 'Series' %}
      {% assign has_series = true %}
    {% endif %}
  {% endfor %}

  {% if has_color %}
    <!-- product options end -->
    <div class="colors">
      <!-- Product Options -->
      <div class="product-options">
        {%- for option in product.options_with_values -%}
          {%- assign option_name_downcase = option.name | downcase | escape | handleize -%}
          {%- if option_name_downcase == 'color' -%}
            <div class="option-group">
              <div class="options {{ option_name_downcase }}-options">
                {%- for value in option.values -%}
                  <label class="color-label" data-product-id="{{ product.id }}">
                    <input
                      type="radio"
                      name="color-{{- product.id -}}"
                      value="{{- value | downcase -}}"
                      class="color-radio"
                      data-product-id="{{- product.id -}}"
                      {% liquid
                        assign selected_value = ''
                        case option.position
                          when 1
                            assign selected_value = featured_variant.option1
                          when 2
                            assign selected_value = featured_variant.option2
                          when 3
                            assign selected_value = featured_variant.option3
                        endcase
                      %}
                      {%- if selected_value != blank and selected_value | downcase == value | downcase -%}
                        checked
                      {%- endif -%}
                    >
                    {%- assign pcolor = value | downcase | escape | handleize -%}
                    {%- assign pcolor_code = pcolor -%}
                    {%- if pcolor == 'carbon-black' -%}
                      {%- assign pcolor_code = '#0B0B0B' -%}
                    {%- elsif pcolor == 'black' -%}
                      {%- assign pcolor_code = '#000000' -%}
                    {%- elsif pcolor == 'blue' -%}
                      {%- assign pcolor_code = '#0A5BA6' -%}
                    {%- elsif pcolor == 'green' -%}
                      {%- assign pcolor_code = '#34E159' -%}
                    {%- elsif pcolor == 'orange' -%}
                      {%- assign pcolor_code = '#ECBC1E' -%}
                    {%- elsif pcolor == 'gray' or pcolor == 'grey' -%}
                      {%- assign pcolor_code = '#EFEFEF' -%}
                    {%- elsif pcolor == 'hi-vis-lime' -%}
                      {%- assign pcolor_code = '#C7EA46' -%}
                    {%- endif -%}
                    <span style="background-color: {{- pcolor_code -}};" class="color-box"></span>
                    <span class="tick-mark">
                      <svg width="12" height="10" viewBox="0 0 12 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4.58543 6.41413L1.75698 3.58573L0.342773 4.99993L4.58543 9.24263L11.6564 2.17153L10.2422 0.757324L4.58543 6.41413Z" fill="white"/>
                      </svg>
                    </span>
                  </label>
                {%- endfor -%}
              </div>
            </div>
          {%- endif -%}
        {%- endfor -%}
      </div>
    </div>
  {% endif %}
  <!-- product options end -->
  {% comment %}
    {% assign product_form_id = 'quick-add-' | append: section_id | append: product.id %}
    {%- if product.variants_count == 1 -%}
      <div class="quick-add no-js-hidden">
        <product-form data-section-id="{{ section.id }}">
          {%- form 'product',
            product,
            id: product_form_id,
            class: 'form',
            novalidate: 'novalidate',
            data-type: 'add-to-cart-form'
          -%}
            <input
              type="hidden"
              name="id"
              value="{{ product.selected_or_first_available_variant.id }}"
              class="product-variant-id"
              {% if product.selected_or_first_available_variant.available == false %}
                disabled
              {% endif %}
            >
            <button
              id="{{ product_form_id }}-submit"
              type="submit"
              name="add"
              class="quick-add__submit button button--full-width"
              aria-haspopup="dialog"
              aria-labelledby="{{ product_form_id }}-submit title-{{ section_id }}-{{ product.id }}"
              aria-live="polite"
              data-sold-out-message="true"
              {% if product.selected_or_first_available_variant.available == false %}
                disabled
              {% endif %}
            >
              <span>
                {%- if product.selected_or_first_available_variant.available -%}
                  {{ 'products.product.add_to_cart' | t }}
                {%- else -%}
                  {{ 'products.product.sold_out' | t }}
                {%- endif -%}
              </span>
              <span class="sold-out-message hidden">
                {{ 'products.product.sold_out' | t }}
              </span>
              {%- render 'loading-spinner' -%}
            </button>
          {%- endform -%}
        </product-form>
      </div>
    {% else %}
      <button onclick="location.href = '{{ product.url }}';"
        id="{{ product_form_id }}-submit"
        type="submit"
        name="add"
        class="quick-add__submit button button--full-width"
        aria-haspopup="dialog"
        aria-labelledby="{{ product_form_id }}-submit title-{{ section_id }}-{{ card_product.id }}"
        data-product-url="{{ card_product.url }}"
      >
        {{ 'products.product.choose_options' | t }}
        {%- if horizontal_quick_add -%}
          <span class="icon-wrap">
            {{- 'icon-arrow.svg' | inline_asset_content -}}
          </span>
        {%- endif -%}
        {%- render 'loading-spinner' -%}
      </button>
    {% endif %}
  {% endcomment %}
</div>
