{% comment %}
  Renders the compatible products bundle module.
  BEM Structure: .bundle-bundle
{% endcomment %}

{%- assign compatible_products = product.metafields.custom.bundle_products.value | default: product.metafields.custom.compatible_products.value | default: product.metafields.custom.custom_compatible_products.value -%}

{%- if compatible_products != blank -%}
  <section class="bundle-module" {{ block.shopify_attributes }}>
    <div class="bundle-module__header">
      <h3 class="bundle-module__title">{{ block.settings.heading | default: "Compatible Accessories" }}</h3>
      <span class="bundle-module__status-text" data-count-label>Select items to bundle</span>
    </div>

    <compatible-products-form class="bundle-form">
      <div class="bundle-items-list">
        {%- assign visible_counter = 0 -%}
        {%- for item in compatible_products -%}
          {%- liquid
            assign current_variant = item.selected_or_first_available_variant
            unless current_variant
              assign current_variant = item
            endunless
          -%}
          
          {%- if current_variant.available -%}
            {%- assign visible_counter = visible_counter | plus: 1 -%}
            
            <div class="bundle-card" 
                 data-product-id="{{ item.id }}" 
                 data-variant-id="{{ current_variant.id }}" 
                 data-price="{{ current_variant.price }}">
              
              <div class="bundle-card__selection">
                <input type="checkbox" 
                       id="bundle-item-{{ item.id }}-{{ forloop.index }}" 
                       name="compatible_product" 
                       value="{{ current_variant.id }}" 
                       checked
                       class="bundle-card__checkbox">
                <label for="bundle-item-{{ item.id }}-{{ forloop.index }}" class="bundle-card__checkbox-label">
                  <span class="bundle-card__checkbox-box">
                    <svg class="icon icon-checkmark" width="10" height="8" viewBox="0 0 10 8" fill="none">
                      <path d="M1 4L3.5 6.5L9 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </span>
                </label>
              </div>

              <div class="bundle-card__main">
                <div class="bundle-card__media">
                  {%- if item.featured_image != blank -%}
                    <img src="{{ item.featured_image | image_url: width: 160 }}" 
                         alt="{{ item.featured_image.alt | escape }}" 
                         loading="lazy" 
                         width="64" 
                         height="64"
                         class="bundle-card__image">
                  {%- else -%}
                    {{ 'product-1' | placeholder_svg_tag: 'bundle-card__image placeholder' }}
                  {%- endif -%}
                </div>

                <div class="bundle-card__details">
                  <h4 class="bundle-card__product-title">{{ item.title }}</h4>
                  <span class="bundle-card__sku" data-sku-display>{{ current_variant.sku }}</span>

                  <div class="bundle-card__price-row">
                    <div class="bundle-card__price-container">
                      <span class="bundle-card__price {% if current_variant.compare_at_price > current_variant.price %}on-sale{% endif %}" data-item-price>
                        {{ current_variant.price | money }}
                      </span>
                      {%- if current_variant.compare_at_price > current_variant.price -%}
                        <span class="bundle-card__compare-price" data-item-compare-price>
                          {{ current_variant.compare_at_price | money }}
                        </span>
                      {%- endif -%}
                    </div>

                    {%- if item.variants.size > 1 -%}
                      <div class="bundle-card__variant-container">
                        <select class="bundle-card__select" aria-label="Select variant" data-variant-select>
                          {%- for variant in item.variants -%}
                            <option value="{{ variant.id }}" 
                                    data-price="{{ variant.price }}"
                                    data-compare-price="{{ variant.compare_at_price }}"
                                    data-sku="{{ variant.sku }}"
                                    {% if variant.id == current_variant.id %}selected{% endif %}
                                    {% unless variant.available %}disabled{% endunless %}>
                              {{ variant.title }}
                            </option>
                          {%- endfor -%}
                        </select>
                        <span class="bundle-card__badge-label">
                          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-settings">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                          </svg>
                          Configure
                        </span>
                      </div>
                    {%- endif -%}
                  </div>
                </div>
              </div>
            </div>
          {%- endif -%}
        {%- endfor -%}
      </div>

      <div class="bundle-summary">
        <div class="bundle-summary__info">
          <span class="bundle-summary__label">Bundle Total</span>
          <span class="bundle-summary__total" data-total-price></span>
        </div>
        <button type="button" class="bundle-summary__button button">
          <span class="bundle-summary__button-text">Add Bundle</span>
          <div class="bundle-summary__loader hidden">
             <svg class="spinner" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                <circle class="path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle>
             </svg>
          </div>
        </button>
      </div>
    </compatible-products-form>
  </section>

  <script src="{{ 'component-compatible-products.js' | asset_url }}" defer="defer"></script>
{%- endif -%}



