{% comment %}
  Renders a list of compatible products from a metafield.
  Usage:
  {% render 'compatible-products', block: block, product: product %}
{% endcomment %}

{%- assign compatible_products = product.metafields.custom.bundle_products.value | default: product.metafields.custom.compatible_products.value | default: product.metafields.custom.custom_compatible_products.value -%}

{%- if compatible_products != blank -%}
  <div class="compatible-products-wrapper" {{ block.shopify_attributes }}>
    {%- if block.settings.heading != blank -%}
      <div class="compatible-products__header-group">
        <h3 class="compatible-products__heading">{{ block.settings.heading | escape }}</h3>
        <span class="compatible-products__count" data-count-label>Select items to bundle</span>
      </div>
    {%- endif -%}

    <div class="compatible-products__container">
      <compatible-products-form>
        <div class="compatible-products__main-layout">
          <div class="compatible-products__list">
            {%- assign visible_counter = 0 -%}
            
            {%- for item in compatible_products -%}
              {%- liquid
                assign current_variant = item.selected_or_first_available_variant
                unless current_variant
                  assign current_variant = item
                endunless
              -%}
              
              {%- if current_variant.available -%}
                {%- assign visible_counter = visible_counter | plus: 1 -%}
                <div class="compatible-product-card {% if visible_counter > 4 %}hidden-queue-item{% endif %}" 
                     data-product-id="{{ item.id }}" 
                     data-variant-id="{{ current_variant.id }}" 
                     data-price="{{ current_variant.price }}"
                     {% if visible_counter > 4 %}style="display: none;"{% endif %}>
                  
                  <input type="checkbox" 
                         id="compatible-{{ item.id }}-{{ forloop.index }}" 
                         name="compatible_product" 
                         value="{{ current_variant.id }}" 
                         {% if visible_counter <= 4 %}checked{% endif %}
                         class="compatible-checkbox hidden">
                  
                  <div class="compatible-product-card__content">
                    <div class="compatible-product-card__image-wrapper">
                      {%- if item.featured_image != blank -%}
                        <img src="{{ item.featured_image | image_url: width: 120 }}" 
                             alt="{{ item.featured_image.alt | escape }}" 
                             loading="lazy" 
                             width="54" 
                             height="54"
                             class="compatible-product-card__image">
                      {%- else -%}
                        {{ 'product-1' | placeholder_svg_tag: 'compatible-product-card__image placeholder-svg' }}
                      {%- endif -%}
                    </div>

                    <div class="compatible-product-card__info">
                      <div class="compatible-product-card__header">
                        <span class="compatible-product-card__title">{{ item.title }}</span>
                        <div class="compatible-product-card__price">
                          <span class="price-item">{{ current_variant.price | money }}</span>
                        </div>
                      </div>
                      
                      <div class="compatible-product-card__bottom-row">
                        {%- if item.variants.size > 1 -%}
                          <div class="compatible-product-card__variants">
                            <select class="compatible-product-card__variant-select" data-product-id="{{ item.id }}" aria-label="Select variant">
                              {%- for variant in item.variants -%}
                                <option value="{{ variant.id }}" 
                                        data-price="{{ variant.price }}"
                                        data-sku="{{ variant.sku }}"
                                        {% if variant.id == current_variant.id %}selected{% endif %}
                                        {% unless variant.available %}disabled{% endunless %}>
                                  {{ variant.title }}
                                </option>
                              {%- endfor -%}
                            </select>
                          </div>
                        {%- endif -%}
                        <span class="compatible-product-card__status-hint"></span>
                      </div>
                    </div>
                  </div>
                </div>
              {%- endif -%}
            {%- endfor -%}
          </div>

          <div class="compatible-products__actions">
            <div class="compatible-products__total-group">
              <span class="compatible-products__total-label">Total Bundle Price:</span>
              <span class="compatible-products__total-price" data-total-price></span>
            </div>
            <button type="button" class="button button--secondary compatible-products__add-btn">
              Add bundle
            </button>
          </div>
        </div>
      </compatible-products-form>
    </div>
  </div>

  <script src="{{ 'component-compatible-products.js' | asset_url }}" defer="defer"></script>
{%- endif -%}


