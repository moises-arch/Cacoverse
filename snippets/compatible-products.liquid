{% comment %}
  Renders a list of compatible products from a metafield.
  Usage:
  {% render 'compatible-products', block: block, product: product %}
{% endcomment %}

{%- assign compatible_products = product.metafields.custom.bundle_products.value | default: product.metafields.custom.compatible_products.value | default: product.metafields.custom.custom_compatible_products.value -%}

{%- if compatible_products != blank -%}
  <div class="compatible-products-wrapper" {{ block.shopify_attributes }}>
    {%- if block.settings.heading != blank -%}
      <h3 class="compatible-products__heading h4">{{ block.settings.heading | escape }}</h3>
    {%- endif -%}

    <div class="compatible-products__container">
      <compatible-products-form>
        <div class="compatible-products__list">
          {%- assign cart_item_ids = cart.items | map: 'product_id' -%}
          {%- assign visible_count = 0 -%}
          
          {%- for item in compatible_products -%}
            {%- liquid
              comment
              if cart_item_ids contains item.id
                continue
              endif
              endcomment

              assign current_variant = item.selected_or_first_available_variant
              unless current_variant
                assign current_variant = item
              endunless
            -%}
            
            {%- if current_variant.available -%}
              {%- assign visible_count = visible_count | plus: 1 -%}
              <div class="compatible-product-card {% if visible_count > 6 %}hidden-compatible-product{% endif %}" 
                   data-product-id="{{ item.id }}" 
                   data-variant-id="{{ current_variant.id }}" 
                   data-price="{{ current_variant.price }}"
                   {% if visible_count > 6 %}style="display: none;"{% endif %}>
                
                <div class="compatible-product-card__checkbox">
                  <input type="checkbox" 
                         id="compatible-{{ item.id }}" 
                         name="compatible_product" 
                         value="{{ current_variant.id }}" 
                         checked
                         class="compatible-checkbox">
                </div>
                
                <div class="compatible-product-card__image-wrapper">
                  {%- if item.featured_image != blank -%}
                    <img src="{{ item.featured_image | image_url: width: 120 }}" 
                         alt="{{ item.featured_image.alt | escape }}" 
                         loading="lazy" 
                         width="60" 
                         height="60"
                         class="compatible-product-card__image">
                  {%- else -%}
                    {{ 'product-1' | placeholder_svg_tag: 'compatible-product-card__image placeholder-svg' }}
                  {%- endif -%}
                </div>

                <div class="compatible-product-card__info">
                  <label for="compatible-{{ item.id }}" class="compatible-product-card__title">
                    {{ item.title | truncate: 40 }}
                  </label>
                  <div class="compatible-product-card__meta">
                    {%- if current_variant.sku != blank -%}
                      <span class="compatible-product-card__sku">{{ current_variant.sku }}</span>
                    {%- endif -%}
                    <div class="compatible-product-card__price">
                      <span class="price-item">{{ current_variant.price | money }}</span>
                    </div>
                  </div>
                  
                  {%- if item.variants.size > 1 -%}
                    <div class="compatible-product-card__variants">
                      <select class="compatible-product-card__variant-select" data-product-id="{{ item.id }}">
                        {%- for variant in item.variants -%}
                          <option value="{{ variant.id }}" 
                                  data-price="{{ variant.price }}"
                                  data-sku="{{ variant.sku }}"
                                  {% if variant.id == current_variant.id %}selected{% endif %}
                                  {% unless variant.available %}disabled{% endunless %}>
                            {{ variant.title }} - {{ variant.price | money }}
                          </option>
                        {%- endfor -%}
                      </select>
                    </div>
                  {%- endif -%}
                  </div>
                </div>
              </div>
            {%- endif -%}
          {%- endfor -%}
        </div>
        
        {%- if visible_count > 6 -%}
          <div class="compatible-products__load-more-container">
            <button type="button" class="link compatible-products__load-more-btn">
              Load more
            </button>
          </div>
        {%- endif -%}


        <div class="compatible-products__actions">
          <div class="compatible-products__total">
            <span class="compatible-products__total-label">Total:</span>
            <span class="compatible-products__total-price" data-total-price></span>
            <span class="compatible-products__count" data-count>(0 items)</span>
          </div>
          <button type="button" class="button button--primary compatible-products__add-btn" disabled>
            {{ 'products.product.add_to_cart' | t }}
          </button>
        </div>
      </compatible-products-form>
    </div>
  </div>

  <script src="{{ 'component-compatible-products.js' | asset_url }}" defer="defer"></script>
{%- endif -%}
