{% doc %}
  @prompt
    Create a Shopify section that displays product recommendations under the title “You may also like” on product pages.
    
    Requirements
    
    Use Shopify’s Recommendations API (recommendations.products) to show related products.
    
    If there are no recommendations, show products from the same collection (excluding the current product).
    
    Limit to 8 products max.
    
    Layout
    
    Max width: 1500px, centered.
    
    Heading: “You may also like” (editable in Theme Editor).
    
    Grid or Carousel view (toggle in settings).
    
    Desktop: 4 items per row
    
    Tablet: 3 items per row
    
    Mobile: 2 items per row (scrollable)
    
    Product Card
    
    Each product card should include:
    
    Product image → links to product page
    
    Product title → links to product page
    
    Price (with compare-at price if available)
    
    Optional subtitle (from product.metafields.custom.sub_title)
    
    Optional color swatches (only if “Color” option exists)
    
    Settings in Theme Editor
    
    Heading text
    
    Layout: grid or carousel
    
    Max number of products
    
    Toggle to show/hide:
    
    Price
    
    Subtitle
    
    Color swatches
    
    “Add to cart” button
    
    Image ratio (natural, square, or portrait)
    
    Optional autoplay for carousel (with adjustable speed)
    
    Design
    
    Match theme fonts and colors.
    
    Rounded corners and soft shadows (adjustable).
    
    Lazy-load all but the first 2 images.
    
    Fully responsive (mobile-first).
    
    Hide section if fewer than 2 products.
    
    Accessibility & Performance
    
    Keyboard navigation and visible focus states.
    
    Pause autoplay on hover and when prefers-reduced-motion is active.
    
    Use aria-label="You may also like" on the section.
    
    No external JS libraries (only vanilla JS).
    
    Deliverable
    
    A single .liquid section file with:
    
    Liquid markup
    
    Inline CSS (scoped to the section)
    
    Inline JS for carousel functionality
    
    A valid JSON schema for Theme Editor settings
{% enddoc %}
{% assign ai_gen_id = section.id | replace: '_', '' | downcase %}

{% liquid
  assign recommendations = recommendations.products
  assign fallback_products = blank
  
  if recommendations.size < 2 and product.collections.first
    assign fallback_products = product.collections.first.products | where: 'id', '!=', product.id | limit: section.settings.max_products
  endif
  
  assign display_products = recommendations
  if recommendations.size < 2 and fallback_products.size >= 2
    assign display_products = fallback_products
  endif
  
  assign products_to_show = display_products | limit: section.settings.max_products
%}

{% if products_to_show.size >= 2 %}
  {% style %}
    .ai-product-recommendations-{{ ai_gen_id }} {
      max-width: 1500px;
      margin: 0 auto;
      padding: 0 {{ settings.spacing_grid_horizontal }}px;
      font-family: {{ settings.type_body_font.family }}, {{ settings.type_body_font.fallback_families }};
      font-weight: {{ settings.type_body_font.weight }};
    }

    .ai-product-recommendations-heading-{{ ai_gen_id }} {
      font-family: {{ settings.type_header_font.family }}, {{ settings.type_header_font.fallback_families }};
      font-weight: {{ settings.type_header_font.weight }};
      font-size: calc({{ settings.heading_scale }}% * 2rem);
      margin: 0 0 2rem;
      text-align: center;
      color: rgb(var(--color-foreground));
    }

    .ai-product-recommendations-container-{{ ai_gen_id }} {
      position: relative;
    }

    .ai-product-recommendations-grid-{{ ai_gen_id }} {
      display: grid;
      gap: {{ settings.spacing_grid_horizontal }}px {{ settings.spacing_grid_vertical }}px;
      grid-template-columns: repeat(2, 1fr);
    }

    .ai-product-recommendations-carousel-{{ ai_gen_id }} {
      display: flex;
      overflow-x: auto;
      scroll-behavior: smooth;
      gap: {{ settings.spacing_grid_horizontal }}px;
      scrollbar-width: none;
      -ms-overflow-style: none;
      padding-bottom: 10px;
    }

    .ai-product-recommendations-carousel-{{ ai_gen_id }}::-webkit-scrollbar {
      display: none;
    }

    .ai-product-recommendations-carousel-{{ ai_gen_id }} .ai-product-card-{{ ai_gen_id }} {
      flex: 0 0 calc(50% - {{ settings.spacing_grid_horizontal | divided_by: 2 }}px);
    }

    .ai-product-card-{{ ai_gen_id }} {
      background: rgb(var(--color-background));
      border-radius: {{ settings.card_corner_radius }}px;
      {% if settings.card_style == 'card' %}
        border: {{ settings.card_border_thickness }}px solid rgba(var(--color-foreground), {{ settings.card_border_opacity | divided_by: 100.0 }});
        box-shadow: {{ settings.card_shadow_horizontal_offset }}px {{ settings.card_shadow_vertical_offset }}px {{ settings.card_shadow_blur }}px rgba(var(--color-shadow), {{ settings.card_shadow_opacity | divided_by: 100.0 }});
        padding: {{ settings.card_image_padding }}px;
      {% endif %}
      text-align: {{ settings.card_text_alignment }};
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .ai-product-card-{{ ai_gen_id }}:hover {
      {% if settings.animations_hover_elements == 'vertical-lift' %}
        transform: translateY(-5px);
      {% elsif settings.animations_hover_elements == '3d-lift' %}
        transform: translateY(-5px) scale(1.02);
      {% endif %}
    }

    .ai-product-card-image-{{ ai_gen_id }} {
      position: relative;
      margin-bottom: 1rem;
      border-radius: {{ settings.media_radius }}px;
      overflow: hidden;
      {% if section.settings.image_ratio == 'square' %}
        aspect-ratio: 1;
      {% elsif section.settings.image_ratio == 'portrait' %}
        aspect-ratio: 3/4;
      {% endif %}
    }

    .ai-product-card-image-{{ ai_gen_id }} img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .ai-product-card-{{ ai_gen_id }}:hover .ai-product-card-image-{{ ai_gen_id }} img {
      transform: scale(1.05);
    }

    .ai-product-card-title-{{ ai_gen_id }} {
      font-size: 1rem;
      font-weight: 500;
      margin: 0 0 0.5rem;
      line-height: 1.3;
    }

    .ai-product-card-title-{{ ai_gen_id }} a {
      color: rgb(var(--color-foreground));
      text-decoration: none;
    }

    .ai-product-card-title-{{ ai_gen_id }} a:hover {
      text-decoration: underline;
    }

    .ai-product-card-subtitle-{{ ai_gen_id }} {
      font-size: 0.875rem;
      color: rgba(var(--color-foreground), 0.7);
      margin-bottom: 0.5rem;
    }

    .ai-product-card-price-{{ ai_gen_id }} {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: rgb(var(--color-foreground));
    }

    .ai-product-card-compare-price-{{ ai_gen_id }} {
      text-decoration: line-through;
      color: rgba(var(--color-foreground), 0.6);
      margin-right: 0.5rem;
      font-weight: normal;
    }

    .ai-product-card-swatches-{{ ai_gen_id }} {
      display: flex;
      gap: 0.5rem;
      justify-content: {{ settings.card_text_alignment }};
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .ai-product-card-swatch-{{ ai_gen_id }} {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid rgba(var(--color-foreground), 0.2);
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .ai-product-card-swatch-{{ ai_gen_id }}:hover {
      transform: scale(1.1);
    }

    .ai-product-card-button-{{ ai_gen_id }} {
      background: rgb(var(--color-button));
      color: rgb(var(--color-button-text));
      border: {{ settings.buttons_border_thickness }}px solid rgba(var(--color-button), {{ settings.buttons_border_opacity | divided_by: 100.0 }});
      border-radius: {{ settings.buttons_radius }}px;
      padding: 0.75rem 1.5rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      box-shadow: {{ settings.buttons_shadow_horizontal_offset }}px {{ settings.buttons_shadow_vertical_offset }}px {{ settings.buttons_shadow_blur }}px rgba(var(--color-shadow), {{ settings.buttons_shadow_opacity | divided_by: 100.0 }});
    }

    .ai-product-card-button-{{ ai_gen_id }}:hover {
      background: rgba(var(--color-button), 0.8);
      transform: translateY(-2px);
    }

    .ai-product-card-button-{{ ai_gen_id }}:focus {
      outline: 2px solid rgb(var(--color-button));
      outline-offset: 2px;
    }

    .ai-carousel-controls-{{ ai_gen_id }} {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .ai-carousel-button-{{ ai_gen_id }} {
      background: rgb(var(--color-button));
      color: rgb(var(--color-button-text));
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .ai-carousel-button-{{ ai_gen_id }}:hover {
      background: rgba(var(--color-button), 0.8);
      transform: scale(1.1);
    }

    .ai-carousel-button-{{ ai_gen_id }}:focus {
      outline: 2px solid rgb(var(--color-button));
      outline-offset: 2px;
    }

    .ai-carousel-button-{{ ai_gen_id }}:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    @media screen and (min-width: 750px) {
      .ai-product-recommendations-grid-{{ ai_gen_id }} {
        grid-template-columns: repeat(3, 1fr);
      }

      .ai-product-recommendations-carousel-{{ ai_gen_id }} .ai-product-card-{{ ai_gen_id }} {
        flex: 0 0 calc(33.333% - {{ settings.spacing_grid_horizontal | times: 2 | divided_by: 3 }}px);
      }
    }

    @media screen and (min-width: 990px) {
      .ai-product-recommendations-grid-{{ ai_gen_id }} {
        grid-template-columns: repeat(4, 1fr);
      }

      .ai-product-recommendations-carousel-{{ ai_gen_id }} .ai-product-card-{{ ai_gen_id }} {
        flex: 0 0 calc(25% - {{ settings.spacing_grid_horizontal | times: 3 | divided_by: 4 }}px);
      }
    }

    @media (prefers-reduced-motion: reduce) {
      .ai-product-card-{{ ai_gen_id }},
      .ai-product-card-image-{{ ai_gen_id }} img,
      .ai-carousel-button-{{ ai_gen_id }} {
        transition: none;
      }
    }
  {% endstyle %}

  <product-recommendations-{{ ai_gen_id }}
    class="ai-product-recommendations-{{ ai_gen_id }}"
    aria-label="{{ section.settings.heading | escape }}"
    data-layout="{{ section.settings.layout }}"
    data-autoplay="{{ section.settings.enable_autoplay }}"
    data-autoplay-speed="{{ section.settings.autoplay_speed }}"
    {{ section.shopify_attributes }}
  >
    {% if section.settings.heading != blank %}
      <h2 class="ai-product-recommendations-heading-{{ ai_gen_id }}">
        {{ section.settings.heading }}
      </h2>
    {% endif %}

    <div class="ai-product-recommendations-container-{{ ai_gen_id }}">
      <div class="ai-product-recommendations-{{ section.settings.layout }}-{{ ai_gen_id }}">
        {% for product in products_to_show %}
          <div class="ai-product-card-{{ ai_gen_id }}">
            <div class="ai-product-card-image-{{ ai_gen_id }}">
              <a href="{{ product.url }}">
                {% if product.featured_image %}
                  <img
                    src="{{ product.featured_image | image_url: width: 400 }}"
                    alt="{{ product.featured_image.alt | escape }}"
                    width="400"
                    height="400"
                    {% if forloop.index > 2 %}loading="lazy"{% endif %}
                  >
                {% else %}
                  <div class="ai-product-card-placeholder-{{ ai_gen_id }}">
                    {{ 'product-1' | placeholder_svg_tag }}
                  </div>
                {% endif %}
              </a>
            </div>

            <div class="ai-product-card-content-{{ ai_gen_id }}">
              <h3 class="ai-product-card-title-{{ ai_gen_id }}">
                <a href="{{ product.url }}">{{ product.title }}</a>
              </h3>

              {% if section.settings.show_subtitle and product.metafields.custom.sub_title %}
                <div class="ai-product-card-subtitle-{{ ai_gen_id }}">
                  {{ product.metafields.custom.sub_title }}
                </div>
              {% endif %}

              {% if section.settings.show_price %}
                <div class="ai-product-card-price-{{ ai_gen_id }}">
                  {% if product.compare_at_price > product.price %}
                    <span class="ai-product-card-compare-price-{{ ai_gen_id }}">
                      {{ product.compare_at_price | money }}
                    </span>
                  {% endif %}
                  {{ product.price | money }}
                </div>
              {% endif %}

              {% if section.settings.show_color_swatches %}
                {% assign color_option = product.options_with_values | where: 'name', 'Color' | first %}
                {% if color_option %}
                  <div class="ai-product-card-swatches-{{ ai_gen_id }}">
                    {% for value in color_option.values limit: 5 %}
                      {% assign color_handle = value | handle %}
                      <div
                        class="ai-product-card-swatch-{{ ai_gen_id }}"
                        style="background-color: {{ value | downcase }};"
                        title="{{ value }}"
                      ></div>
                    {% endfor %}
                  </div>
                {% endif %}
              {% endif %}

              {% if section.settings.show_add_to_cart %}
                <a
                  href="{{ product.url }}"
                  class="ai-product-card-button-{{ ai_gen_id }}"
                >
                  {% if product.available %}
                    Add to cart
                  {% else %}
                    Sold out
                  {% endif %}
                </a>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>

      {% if section.settings.layout == 'carousel' %}
        <div class="ai-carousel-controls-{{ ai_gen_id }}">
          <button
            class="ai-carousel-button-{{ ai_gen_id }} ai-carousel-prev-{{ ai_gen_id }}"
            aria-label="Previous products"
          >
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M10 12L6 8l4-4"/>
            </svg>
          </button>
          <button
            class="ai-carousel-button-{{ ai_gen_id }} ai-carousel-next-{{ ai_gen_id }}"
            aria-label="Next products"
          >
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M6 4l4 4-4 4"/>
            </svg>
          </button>
        </div>
      {% endif %}
    </div>
  </product-recommendations-{{ ai_gen_id }}>

  <script>
    (function() {
      class ProductRecommendations{{ ai_gen_id }} extends HTMLElement {
        constructor() {
          super();
          this.carousel = null;
          this.prevButton = null;
          this.nextButton = null;
          this.autoplayInterval = null;
          this.isHovered = false;
        }

        connectedCallback() {
          this.carousel = this.querySelector('.ai-product-recommendations-carousel-{{ ai_gen_id }}');
          this.prevButton = this.querySelector('.ai-carousel-prev-{{ ai_gen_id }}');
          this.nextButton = this.querySelector('.ai-carousel-next-{{ ai_gen_id }}');

          if (this.dataset.layout === 'carousel') {
            this.setupCarousel();
            this.setupAutoplay();
          }
        }

        setupCarousel() {
          if (!this.carousel || !this.prevButton || !this.nextButton) return;

          this.prevButton.addEventListener('click', () => this.scrollPrev());
          this.nextButton.addEventListener('click', () => this.scrollNext());

          this.carousel.addEventListener('scroll', () => this.updateButtons());
          this.updateButtons();

          this.carousel.addEventListener('mouseenter', () => {
            this.isHovered = true;
            this.pauseAutoplay();
          });

          this.carousel.addEventListener('mouseleave', () => {
            this.isHovered = false;
            this.resumeAutoplay();
          });

          this.carousel.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
              e.preventDefault();
              this.scrollPrev();
            } else if (e.key === 'ArrowRight') {
              e.preventDefault();
              this.scrollNext();
            }
          });
        }

        setupAutoplay() {
          if (this.dataset.autoplay === 'true' && !window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
            const speed = parseInt(this.dataset.autoplaySpeed) * 1000;
            this.autoplayInterval = setInterval(() => {
              if (!this.isHovered) {
                this.scrollNext();
              }
            }, speed);
          }
        }

        scrollPrev() {
          if (!this.carousel) return;
          const scrollAmount = this.carousel.clientWidth * 0.8;
          this.carousel.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
        }

        scrollNext() {
          if (!this.carousel) return;
          const scrollAmount = this.carousel.clientWidth * 0.8;
          const maxScroll = this.carousel.scrollWidth - this.carousel.clientWidth;
          
          if (this.carousel.scrollLeft >= maxScroll - 10) {
            this.carousel.scrollTo({ left: 0, behavior: 'smooth' });
          } else {
            this.carousel.scrollBy({ left: scrollAmount, behavior: 'smooth' });
          }
        }

        updateButtons() {
          if (!this.carousel || !this.prevButton || !this.nextButton) return;

          const isAtStart = this.carousel.scrollLeft <= 10;
          const isAtEnd = this.carousel.scrollLeft >= this.carousel.scrollWidth - this.carousel.clientWidth - 10;

          this.prevButton.disabled = isAtStart;
          this.nextButton.disabled = false;
        }

        pauseAutoplay() {
          if (this.autoplayInterval) {
            clearInterval(this.autoplayInterval);
            this.autoplayInterval = null;
          }
        }

        resumeAutoplay() {
          if (this.dataset.autoplay === 'true' && !window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
            this.setupAutoplay();
          }
        }

        disconnectedCallback() {
          this.pauseAutoplay();
        }
      }

      customElements.define('product-recommendations-{{ ai_gen_id }}', ProductRecommendations{{ ai_gen_id }});
    })();
  </script>
{% endif %}

{% schema %}
{
  "name": "Product recommendations",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "You may also like"
    },
    {
      "type": "range",
      "id": "max_products",
      "min": 2,
      "max": 8,
      "step": 1,
      "label": "Maximum products",
      "default": 4
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "layout",
      "label": "Layout",
      "options": [
        {
          "value": "grid",
          "label": "Grid"
        },
        {
          "value": "carousel",
          "label": "Carousel"
        }
      ],
      "default": "grid"
    },
    {
      "type": "select",
      "id": "image_ratio",
      "label": "Image ratio",
      "options": [
        {
          "value": "natural",
          "label": "Natural"
        },
        {
          "value": "square",
          "label": "Square"
        },
        {
          "value": "portrait",
          "label": "Portrait"
        }
      ],
      "default": "natural"
    },
    {
      "type": "header",
      "content": "Product card"
    },
    {
      "type": "checkbox",
      "id": "show_price",
      "label": "Show price",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_subtitle",
      "label": "Show subtitle",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_color_swatches",
      "label": "Show color swatches",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_add_to_cart",
      "label": "Show add to cart button",
      "default": false
    },
    {
      "type": "header",
      "content": "Carousel settings"
    },
    {
      "type": "checkbox",
      "id": "enable_autoplay",
      "label": "Enable autoplay",
      "default": false
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "min": 2,
      "max": 10,
      "step": 1,
      "unit": "s",
      "label": "Autoplay speed",
      "default": 5
    }
  ],
  "presets": [
    {
      "name": "Product recommendations"
    }
  ]
}
{% endschema %}