{% comment %}
Mobile-only slide drawer with sliding submenus (2–3 levels) + big Close button.
No dependency on Bootstrap. Desktop remains untouched.
{% endcomment %}

{% assign nav_handle = section.settings.nav_menu | default: 'main-menu' %}
{% assign nav = linklists[nav_handle] %}

<div class="msd" id="msd-{{ section.id }}">
  <!-- Mobile: built-in toggle (hamburger) -->
  <button class="msd__toggle d-lg-none" aria-controls="msd-drawer-{{ section.id }}" aria-expanded="false">
    <span class="msd__bar"></span>
    <span class="msd__bar"></span>
    <span class="msd__bar"></span>
    <span class="visually-hidden">Open menu</span>
  </button>

  <!-- Overlay -->
  <div class="msd__overlay" data-msd-overlay hidden></div>

  <!-- Drawer -->
  <aside
    class="msd__drawer"
    id="msd-drawer-{{ section.id }}"
    role="dialog"
    aria-modal="true"
    aria-label="Mobile menu"
    hidden
  >
    <div class="msd__head">
      <span class="msd__title">{{ section.settings.title | default: 'Menu' }}</span>
      <button class="msd__close" data-msd-close aria-label="Close menu">
        {{ section.settings.close_text | default: 'Close ✕' }}
      </button>
    </div>

    <!-- Panels rail (slides horizontally) -->
    <div class="msd__rail" data-msd-rail>
      {%- comment -%} PANEL 0 (ROOT) {%- endcomment -%}
      <section class="msd__panel is-active" data-msd-panel data-level="0" aria-label="Main navigation">
        <ul class="msd__list" role="menu">
          {%- for l1 in nav.links -%}
            <li class="msd__item" role="none">
              {%- if l1.links != blank -%}
                <button class="msd__link msd__link--parent" role="menuitem"
                        data-msd-goto="l1-{{ forloop.index }}"
                        aria-haspopup="true" aria-expanded="false">
                  <span>{{ l1.title }}</span>
                  <span class="msd__chev" aria-hidden="true">›</span>
                </button>
              {%- else -%}
                <a class="msd__link" href="{{ l1.url }}" role="menuitem">{{ l1.title }}</a>
              {%- endif -%}
            </li>
          {%- endfor -%}

          {%- if section.settings.show_search or section.settings.show_account -%}
            <li class="msd__divider" aria-hidden="true"></li>
          {%- endif -%}

          {%- if section.settings.show_search -%}
            <li class="msd__item">
              <form action="{{ routes.search_url }}" method="get" role="search" class="msd__search">
                <label class="visually-hidden" for="CacoSearchInputDrawer-{{ section.id }}">Search</label>
                <input id="CacoSearchInputDrawer-{{ section.id }}" type="search" name="q" placeholder="{{ 'general.search.search' | t | default: 'Search' }}" aria-label="Search">
                <button type="submit">{{ 'general.search.submit' | t | default: 'Search' }}</button>
              </form>
            </li>
          {%- endif -%}

          {%- if section.settings.show_account -%}
            <li class="msd__item">
              <a class="msd__link" href="{% if customer %}{{ routes.account_url }}{% else %}{{ routes.account_login_url }}{% endif %}">
                {{ 'customer.account.title' | t | default: 'Account' }}
              </a>
            </li>
          {%- endif -%}
        </ul>
      </section>

      {%- comment -%} LEVEL 1 PANELS {%- endcomment -%}
      {%- for l1 in nav.links -%}
        {%- if l1.links != blank -%}
          <section class="msd__panel" id="panel-l1-{{ forloop.index }}" data-msd-panel data-level="1" aria-label="{{ l1.title }}">
            <header class="msd__subhead">
              <button class="msd__back" data-msd-back aria-label="Go back">‹ Back</button>
              <a class="msd__heading" href="{{ l1.url }}">{{ l1.title }}</a>
            </header>
            <ul class="msd__list" role="menu">
              {%- for l2 in l1.links -%}
                <li class="msd__item" role="none">
                  {%- if l2.links != blank -%}
                    <button class="msd__link msd__link--parent" role="menuitem"
                            data-msd-goto="l1-{{ forloop.parentloop.index }}-l2-{{ forloop.index }}"
                            aria-haspopup="true" aria-expanded="false">
                      <span>{{ l2.title }}</span>
                      <span class="msd__chev" aria-hidden="true">›</span>
                    </button>
                  {%- else -%}
                    <a class="msd__link" href="{{ l2.url }}" role="menuitem">{{ l2.title }}</a>
                  {%- endif -%}
                </li>
              {%- endfor -%}
            </ul>
          </section>

          {%- comment -%} LEVEL 2 PANELS (optional third level) {%- endcomment -%}
          {%- for l2 in l1.links -%}
            {%- if l2.links != blank -%}
              <section class="msd__panel" id="panel-l1-{{ forloop.parentloop.index }}-l2-{{ forloop.index }}" data-msd-panel data-level="2" aria-label="{{ l2.title }}">
                <header class="msd__subhead">
                  <button class="msd__back" data-msd-back aria-label="Go back">‹ Back</button>
                  <a class="msd__heading" href="{{ l2.url }}">{{ l2.title }}</a>
                </header>
                <ul class="msd__list" role="menu">
                  {%- for l3 in l2.links -%}
                    <li class="msd__item" role="none">
                      <a class="msd__link" href="{{ l3.url }}" role="menuitem">{{ l3.title }}</a>
                    </li>
                  {%- endfor -%}
                </ul>
              </section>
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
      {%- endfor -%}
    </div>
  </aside>
</div>

{% style %}
/* ====== Mobile Slide Drawer — styles (scoped) ====== */
#msd-{{ section.id }}{ --bg:#fff; --text:#111; --muted:#6b7280; --border:#e5e7eb; --accent: {{ section.settings.accent | default: '#0a5ba6' }}; --w: 88vw; --z: 9999; font-family: 'Barlow',sans-serif; }
#msd-{{ section.id }} .visually-hidden{position:absolute!important;clip:rect(1px,1px,1px,1px);padding:0;border:0;height:1px;width:1px;overflow:hidden;white-space:nowrap;}
/* Toggle */
#msd-{{ section.id }} .msd__toggle{display:inline-flex;flex-direction:column;gap:4px;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff;color:var(--text);}
#msd-{{ section.id }} .msd__bar{width:22px;height:2px;background:currentColor;border-radius:2px;display:block;}
/* Hide on desktop */
@media(min-width: 992px){ #msd-{{ section.id }} .msd__toggle{ display:none } }
/* Overlay */
#msd-{{ section.id }} .msd__overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:saturate(120%) blur(1px);z-index:var(--z);opacity:0;transition:opacity .25s;}
#msd-{{ section.id }} .msd__overlay.is-open{opacity:1;}
/* Drawer */
#msd-{{ section.id }} .msd__drawer{position:fixed;inset:0 auto 0 0;width:var(--w);max-width:420px;background:var(--bg);z-index:calc(var(--z) + 1);box-shadow:2px 0 30px rgba(0,0,0,.18);transform:translateX(-105%);transition:transform .3s;display:flex;flex-direction:column;}
#msd-{{ section.id }} .msd__drawer.is-open{transform:translateX(0);}
#msd-{{ section.id }} .msd__head{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px;border-bottom:1px solid var(--border);}
#msd-{{ section.id }} .msd__title{font-weight:800;letter-spacing:.2px;color:var(--text);}
#msd-{{ section.id }} .msd__close{font-size:16px;line-height:1;border:2px solid var(--text);padding:12px 16px;border-radius:999px;background:#fff;font-weight:800}
#msd-{{ section.id }} .msd__close:active{transform:scale(.98)}
/* Rail + Panels */
#msd-{{ section.id }} .msd__rail{position:relative;flex:1;display:flex;height:100%;overflow:hidden;touch-action:pan-y;transition:transform .28s cubic-bezier(.2,.8,.2,1);}
#msd-{{ section.id }} .msd__panel{min-width:100%;height:100%;overflow:auto;-webkit-overflow-scrolling:touch;background:#fff;}
/* Lists */
#msd-{{ section.id }} .msd__list{list-style:none;margin:0;padding:10px 0;}
#msd-{{ section.id }} .msd__item{margin:0;padding:0;}
#msd-{{ section.id }} .msd__divider{height:1px;background:var(--border);margin:10px 16px;}
#msd-{{ section.id }} .msd__link{display:flex;justify-content:space-between;align-items:center;gap:10px;width:100%;padding:14px 16px;font-size:16px;color:var(--text);text-decoration:none;border-bottom:1px solid var(--border);background:#fff;}
#msd-{{ section.id }} .msd__link--parent{font-weight:700;}
#msd-{{ section.id }} .msd__chev{font-size:22px;color:var(--muted)}
#msd-{{ section.id }} .msd__subhead{position:sticky;top:0;background:#fff;z-index:1;display:flex;align-items:center;gap:8px;padding:12px 12px;border-bottom:1px solid var(--border);}
#msd-{{ section.id }} .msd__back{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
#msd-{{ section.id }} .msd__heading{font-weight:800;color:var(--text);text-decoration:none;margin-left:4px;}
#msd-{{ section.id }} .msd__search{display:flex;gap:8px;padding:8px 16px}
#msd-{{ section.id }} .msd__search input{flex:1;border:1px solid var(--border);border-radius:999px;padding:10px 14px}
#msd-{{ section.id }} .msd__search button{border-radius:999px;padding:10px 14px;border:1px solid var(--accent);background:var(--accent);color:#fff}
/* Hide the whole drawer & overlay on desktop */
@media(min-width: 992px){ #msd-{{ section.id }} .msd__overlay,#msd-{{ section.id }} .msd__drawer{ display:none!important } }
{% endstyle %}










<script>
(() => {
  const root = document.getElementById('msd-{{ section.id }}');
  if (!root) return;

  const overlay = root.querySelector('[data-msd-overlay]');
  const drawer  = root.querySelector('.msd__drawer');
  const rail    = root.querySelector('[data-msd-rail]');
  const toggle  = root.querySelector('.msd__toggle');
  const closeBtns = root.querySelectorAll('[data-msd-close]');
  const gotoBtns  = root.querySelectorAll('[data-msd-goto]');
  const backBtns  = root.querySelectorAll('[data-msd-back]');

  // --- Build a flat ordered list of panels and index them
  const panels = Array.from(root.querySelectorAll('[data-msd-panel]'));
  const panelIndexById = new Map();
  panels.forEach((p, i) => { p.dataset.idx = i; panelIndexById.set(p.id || '', i); });

  // --- Navigation state
  let currentIdx = 0;
  const historyStack = [0]; // start at root (index 0)

  function slideToIndex(idx) {
    currentIdx = Math.max(0, Math.min(idx, panels.length - 1));
    rail.style.transform = `translateX(-${currentIdx * 100}%)`;
  }

  function open() {
    drawer.hidden = false; overlay.hidden = false;
    requestAnimationFrame(() => {
      drawer.classList.add('is-open'); overlay.classList.add('is-open');
      toggle?.setAttribute('aria-expanded','true');
      trapFocus(drawer);

      // lock scroll (iOS-safe)
      const y = window.scrollY || document.documentElement.scrollTop || 0;
      document.documentElement.classList.add('nav-locked');
      document.body.classList.add('nav-locked');
      document.body.style.position = 'fixed';
      document.body.style.top = `-${y}px`;
      document.body.style.left = '0'; document.body.style.right = '0'; document.body.style.width = '100%';
      drawer._lockY = y;
    });
  }

  function close() {
    drawer.classList.remove('is-open'); overlay.classList.remove('is-open');
    toggle?.setAttribute('aria-expanded','false');
    // reset to root
    historyStack.length = 1; // keep only the root
    slideToIndex(0);
    setTimeout(() => {
      drawer.hidden = true; overlay.hidden = true; releaseFocus();
      // unlock scroll and restore
      document.documentElement.classList.remove('nav-locked');
      document.body.classList.remove('nav-locked');
      const y = Math.abs(parseInt(document.body.style.top || '0', 10)) || 0;
      document.body.style.position=''; document.body.style.top=''; document.body.style.left='';
      document.body.style.right=''; document.body.style.width='';
      window.scrollTo(0, y);
    }, 240);
  }

  // --- Wire forward nav (goto)
  gotoBtns.forEach(btn => {
    const token = btn.getAttribute('data-msd-goto'); // e.g. "l1-1" or "l1-2-l2-3"
    const panel = root.querySelector(`#panel-${token}`);
    if (!panel) return;

    const idx = parseInt(panel.dataset.idx, 10);
    btn.addEventListener('click', () => {
      historyStack.push(idx);
      slideToIndex(idx);
      btn.setAttribute('aria-expanded', 'true');
      setTimeout(() => { (panel.querySelector('.msd__link, .msd__back') || toggle).focus(); }, 180);
    });
  });

  // --- Wire back nav
  backBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      if (historyStack.length > 1) historyStack.pop(); // discard current
      const prevIdx = historyStack[historyStack.length - 1] ?? 0;
      slideToIndex(prevIdx);
      setTimeout(() => {
        const prevPanel = panels[prevIdx];
        (prevPanel?.querySelector('.msd__link, .msd__back') || toggle).focus();
      }, 160);
    });
  });

  // --- Open/close triggers
  toggle?.addEventListener('click', e => { e.preventDefault(); open(); });
  overlay?.addEventListener('click', close);
  closeBtns.forEach(b => b.addEventListener('click', close));
  document.addEventListener('keydown', e => { if (e.key === 'Escape' && !drawer.hidden) close(); });

  // --- Focus trap (unchanged)
  let prevFocus = null, trapHandler = null;
  function trapFocus(el){
    prevFocus = document.activeElement;
    trapHandler = () => {
      if (!el.contains(document.activeElement)) {
        (el.querySelector('button,a,input,[tabindex]:not([tabindex="-1"])') || el).focus();
      }
    };
    el.addEventListener('focusout', trapHandler);
    (el.querySelector('button,a,input,[tabindex]:not([tabindex="-1"])') || el).focus();
  }
  function releaseFocus(){
    if (trapHandler){ drawer.removeEventListener('focusout', trapHandler); trapHandler = null; }
    prevFocus && prevFocus.focus();
  }

  // Optional API
  window.__msd_open = open;
  window.__msd_close = close;
})();
</script>













{% schema %}
{
  "name": "Mobile Slide Drawer",
  "class": "section-mobile-slide-drawer",
  "settings": [
    { "type": "link_list", "id": "nav_menu", "label": "Mobile navigation", "default": "main-menu" },
    { "type": "text", "id": "title", "label": "Drawer title", "default": "Menu" },
    { "type": "checkbox", "id": "show_search", "label": "Show search", "default": true },
    { "type": "checkbox", "id": "show_account", "label": "Show account link", "default": false },
    { "type": "text", "id": "close_text", "label": "Close button text", "default": "Close ✕" },
    { "type": "color", "id": "accent", "label": "Accent color", "default": "#0a5ba6" }
  ],
  "presets": [{ "name": "Mobile Slide Drawer" }]
}
{% endschema %}




