{% comment %}
Section: ge-helmet-compare.liquid
Purpose: Let admins choose helmets and define characteristics (with icons); render product cards with a button that opens a popup chart of bar-levels per characteristic. Users can also select multiple helmets to open a side-by-side compare modal.

Admin setup (recommended metafields on Product):
- Namespace: ge_specs
- Keys (one per characteristic). Example keys: ventilation, sun_protection, impact_protection, heat_protection, warranty, customization, lightweight, comfort, design
- Type: Integer (1-5) or Number (min 0, max 5)

Notes:
- You can add/remove characteristics in the section itself; the section will look for a product metafield with the exact slug/key you define. If not found, value defaults to 0.
- Icons: provide an SVG path or leave blank to use a default icon.
- Includes an optional disclosure line (per GE license guidelines) toggleable in settings.
{% endcomment %}

<section id="ge-helmet-compare-{{ section.id }}" class="gehc section-{{ section.id }}-padding">
  <div class="gehc__inner page-width">
    {% if section.settings.heading != '' %}
      <div class="gehc__header">
        <h2 class="gehc__title">{{ section.settings.heading }}</h2>
        {% if section.settings.subheading != '' %}
          <p class="gehc__subtitle">{{ section.settings.subheading }}</p>
        {% endif %}
      </div>
    {% endif %}

    <div class="gehc__toolbar">
      <div class="gehc__legend">
        <span class="gehc__legend-dot"></span>
        <span>Level (0–{{ section.settings.max_scale }})</span>
      </div>
      <div class="gehc__compare-cta" hidden>
        <button class="gehc-btn gehc-btn--primary" data-compare-open>
          Compare (<span data-compare-count>0</span>)
        </button>
        <button class="gehc-btn gehc-btn--ghost" data-compare-clear>Clear</button>
      </div>
    </div>

    <div class="gehc__grid">
      {% assign characteristics = section.blocks | where: 'type', 'characteristic' %}
      {% assign products = section.blocks | where: 'type', 'product' %}

      {% if products.size == 0 %}
        <p class="gehc__empty">Add some helmets in the section settings to get started.</p>
      {% endif %}

      {% for block in products %}
        {% assign p = block.settings.product %}
        {% if p %}
          {% capture product_data_json %}
            {
              "id": {{ p.id | json }},
              "handle": {{ p.handle | json }},
              "title": {{ p.title | json }},
              "url": {{ p.url | json }},
              "image": {{ p.featured_image | img_url: '540x540', scale: 2 | json }},
              "price": {{ p.price | money | strip_html | json }},
              "scores": {
                {% for c in characteristics %}
                  {% assign key = c.settings.key | strip | handleize %}
                  {% if forloop.index0 > 0 %},{% endif %}
                  {{ key | json }}: {{ p.metafields['ge_specs'][key] | default: 0 | plus: 0 | json }}
                {% endfor %}
              }
            }
          {% endcapture %}

          <article class="gehc-card" data-product
                   data-product-json='{{ product_data_json | strip_newlines | escape }}'
                   {{ block.shopify_attributes }}>
            <div class="gehc-card__media">
              <a href="{{ p.url }}" class="gehc-card__img-link" aria-label="Open {{ p.title }}">
                {% if p.featured_image %}
                  <img src="{{ p.featured_image | img_url: '540x540', scale: 2 }}" alt="{{ p.title | escape }}" loading="lazy" width="540" height="540">
                {% else %}
                  <div class="gehc-card__img--placeholder" aria-hidden="true"></div>
                {% endif %}
              </a>
            </div>
            <div class="gehc-card__body">
              <h3 class="gehc-card__title"><a href="{{ p.url }}">{{ p.title }}</a></h3>
              <div class="gehc-card__price">{{ p.price | money }}</div>

              <div class="gehc-bars">
                {% for c in characteristics %}
                  {% assign key = c.settings.key | strip | handleize %}
                  {% assign label = c.settings.label | default: c.settings.key %}
                  {% assign max = section.settings.max_scale %}
                  {% assign val = p.metafields['ge_specs'][key] | default: 0 | plus: 0 %}
                  <div class="gehc-bar" data-bar data-key="{{ key }}" aria-label="{{ label }} level {{ val }} of {{ max }}">
                    <div class="gehc-bar__label">
                      <span class="gehc-icon" aria-hidden="true">
                        {% if c.settings.icon_path != '' %}
                          <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="{{ c.settings.icon_path }}"/></svg>
                        {% else %}
                          {%- comment -%} Default dot icon {%- endcomment -%}
                          <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><circle cx="12" cy="12" r="6"/></svg>
                        {% endif %}
                      </span>
                      <span class="gehc-bar__text">{{ label }}</span>
                    </div>
                    <div class="gehc-bar__track" role="meter" aria-valuemin="0" aria-valuemax="{{ max }}" aria-valuenow="{{ val }}">
                      {% assign percent = val | times: 100 | divided_by: max %}
                      <span class="gehc-bar__fill" style="width: {{ percent }}%"></span>
                      <span class="gehc-bar__value">{{ val }}</span>
                    </div>
                  </div>
                {% endfor %}
              </div>

              <div class="gehc-card__actions">
                <button class="gehc-btn gehc-btn--ghost" data-quick-chart>View chart</button>
                <label class="gehc-compare">
                  <input type="checkbox" class="gehc-compare__cb" data-compare-toggle>
                  <span>Add to compare</span>
                </label>
              </div>
            </div>
          </article>
        {% endif %}
      {% endfor %}
    </div>

    {% if section.settings.show_disclosure %}
      <p class="gehc__disclosure">{{ section.settings.disclosure_text }}</p>
    {% endif %}
  </div>

  <!-- Single Product Chart Modal -->
  <dialog class="gehc-modal" data-modal="single" aria-label="Helmet details">
    <div class="gehc-modal__box">
      <button class="gehc-modal__close" data-modal-close aria-label="Close">×</button>
      <div class="gehc-modal__content" data-single-content></div>
    </div>
  </dialog>

  <!-- Compare Modal -->
  <dialog class="gehc-modal" data-modal="compare" aria-label="Compare helmets">
    <div class="gehc-modal__box gehc-modal__box--wide">
      <button class="gehc-modal__close" data-modal-close aria-label="Close">×</button>
      <h3 class="gehc-modal__title">Compare helmets</h3>
      <div class="gehc-compare-table" data-compare-table></div>
    </div>
  </dialog>

  <script type="application/json" data-characteristics>
    {
      "max": {{ section.settings.max_scale | json }},
      "items": [
        {% for c in characteristics %}
          {
            "key": {{ c.settings.key | strip | handleize | json }},
            "label": {{ c.settings.label | default: c.settings.key | json }},
            "iconPath": {{ c.settings.icon_path | json }}
          }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      ]
    }
  </script>
</section>

<style>
  /* Container */
  #ge-helmet-compare-{{ section.id }} { --ge-blue:#005EB8; --ge-gray:#63666A; --ge-light:#F4F7FB; --bar-bg:#E6EEF6; --bar-fill:#005EB8; --ok:#00BF6F; --ink:#13294B; }
  #ge-helmet-compare-{{ section.id }} .gehc__header{margin-bottom:1rem}
  #ge-helmet-compare-{{ section.id }} .gehc__title{font-size:clamp(22px,2.2vw,30px);margin:0 0 .25rem;color:var(--ink)}
  #ge-helmet-compare-{{ section.id }} .gehc__subtitle{margin:0;color:#4b5563}
  #ge-helmet-compare-{{ section.id }} .gehc__toolbar{display:flex;justify-content:space-between;align-items:center;margin:12px 0 16px}
  #ge-helmet-compare-{{ section.id }} .gehc__legend{display:flex;gap:8px;align-items:center;color:#4b5563}
  #ge-helmet-compare-{{ section.id }} .gehc__legend-dot{width:12px;height:12px;border-radius:999px;background:var(--bar-fill);display:inline-block}
  #ge-helmet-compare-{{ section.id }} .gehc__grid{display:grid;grid-template-columns:repeat(12,1fr);gap:18px}
  @media (max-width: 989px){#ge-helmet-compare-{{ section.id }} .gehc__grid{grid-template-columns:repeat(6,1fr)}}
  @media (max-width: 599px){#ge-helmet-compare-{{ section.id }} .gehc__grid{grid-template-columns:repeat(2,1fr)}}

  /* Card */
  #ge-helmet-compare-{{ section.id }} .gehc-card{grid-column:span 3;background:#fff;border:1px solid #E6EEF6;border-radius:16px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 6px 18px rgba(0,0,0,.04)}
  @media (max-width: 989px){#ge-helmet-compare-{{ section.id }} .gehc-card{grid-column:span 6}}
  @media (max-width: 599px){#ge-helmet-compare-{{ section.id }} .gehc-card{grid-column:span 2}}
  .gehc-card__media{position:relative;background:var(--ge-light)}
  .gehc-card__img-link{display:block}
  .gehc-card__img--placeholder{padding-top:100%;background:linear-gradient(180deg,#f8fafc,#eef2f7)}
  .gehc-card__body{padding:14px 14px 16px}
  .gehc-card__title{font-size:16px;line-height:1.3;margin:0 0 4px}
  .gehc-card__title a{text-decoration:none;color:var(--ink)}
  .gehc-card__price{font-weight:600;color:#111827;margin-bottom:10px}

  /* Bars */
  .gehc-bars{display:flex;flex-direction:column;gap:10px;margin-bottom:12px}
  .gehc-bar__label{display:flex;align-items:center;gap:8px;font-size:13px;color:#374151}
  .gehc-icon{width:18px;height:18px;color:var(--ge-gray)}
  .gehc-bar__track{position:relative;background:var(--bar-bg);height:10px;border-radius:999px;overflow:hidden}
  .gehc-bar__fill{position:absolute;inset:0 0 0 0;width:0;background:linear-gradient(90deg,var(--bar-fill),#00B5E2);transition:width .35s ease}
  .gehc-bar__value{position:absolute;right:6px;top:50%;transform:translateY(-50%);font-size:11px;color:#0b1628;font-weight:600}

  /* Actions */
  .gehc-card__actions{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .gehc-compare{display:inline-flex;align-items:center;gap:8px;font-size:13px;color:#374151;user-select:none}
  .gehc-compare__cb{width:16px;height:16px}

  /* Buttons */
  .gehc-btn{appearance:none;border:1px solid var(--ge-blue);background:var(--ge-blue);color:#fff;border-radius:999px;padding:8px 14px;font-size:13px;font-weight:600;cursor:pointer}
  .gehc-btn--ghost{background:#fff;color:var(--ge-blue)}
  .gehc-btn[disabled]{opacity:.5;cursor:not-allowed}

  /* Modals */
  .gehc-modal{border:none;border-radius:16px;max-width:min(1100px,96vw);width:fit-content;padding:0;background:transparent}
  .gehc-modal[open]{animation:show .2s ease}
  @keyframes show{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  .gehc-modal::backdrop{background:rgba(19,41,75,.52)}
  .gehc-modal__box{background:#fff;border-radius:16px;box-shadow:0 20px 50px rgba(0,0,0,.25);padding:16px;min-width:min(720px,92vw)}
  .gehc-modal__box--wide{min-width:min(980px,96vw)}
  .gehc-modal__close{position:absolute;right:10px;top:6px;font-size:26px;line-height:1;background:transparent;border:none;color:#111827;cursor:pointer}
  .gehc-modal__title{margin:0 0 8px}

  /* Compare Table */
  .gehc-compare-table{display:grid;gap:12px}
  .gehc-compare-table .gehc-row{display:grid;grid-template-columns:250px repeat(var(--cols), 1fr);gap:10px;align-items:center}
  .gehc-compare-table .gehc-row__label{display:flex;align-items:center;gap:8px;font-weight:600;color:#0b1628}
  .gehc-compare-table .gehc-cell{padding:8px 10px;border:1px solid #E6EEF6;border-radius:10px;background:#fff}
  .gehc-compare-table .gehc-cell--head{display:flex;align-items:center;gap:8px;font-weight:600}
  .gehc-compare-table .gehc-thumb{width:42px;height:42px;border-radius:10px;object-fit:cover;background:#f1f5f9}

  .gehc__disclosure{margin-top:14px;font-size:12px;color:#4b5563}
</style>

<script>
  (function(){
    const root = document.getElementById('ge-helmet-compare-{{ section.id }}');
    if(!root) return;

    const maxScale = Number((JSON.parse(root.querySelector('[data-characteristics]').textContent||'{}').max) || {{ section.settings.max_scale | json }});
    const chars = JSON.parse(root.querySelector('[data-characteristics]').textContent || '{}').items || [];

    const modalSingle = root.querySelector('[data-modal="single"]');
    const modalCompare = root.querySelector('[data-modal="compare"]');
    const singleContent = root.querySelector('[data-single-content]');
    const compareTable = root.querySelector('[data-compare-table]');
    const compareCtaWrap = root.querySelector('.gehc__compare-cta');
    const compareCountEl = root.querySelector('[data-compare-count]');

    const selected = new Map();

    function productFromCard(card){
      try { return JSON.parse(card.getAttribute('data-product-json')); } catch(e){ return null; }
    }

    function openModal(dlg){ if(typeof dlg.showModal === 'function'){ dlg.showModal(); } else { dlg.setAttribute('open',''); } }
    function closeModal(dlg){ if(dlg.open){ dlg.close(); } else { dlg.removeAttribute('open'); } }

    // Single product chart renderer
    function renderSingle(product){
      if(!product) return;
      const bars = chars.map(c=>{
        const val = Number(product.scores?.[c.key] || 0);
        const pct = Math.min(100, Math.round((val/maxScale)*100));
        const icon = c.iconPath ? `<svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="${c.iconPath}"/></svg>` : `<svg viewBox='0 0 24 24' width='18' height='18' fill='currentColor'><circle cx='12' cy='12' r='6'/></svg>`;
        return `
          <div class="gehc-bar" style="margin:8px 0 10px">
            <div class="gehc-bar__label"><span class="gehc-icon">${icon}</span><span class="gehc-bar__text">${c.label}</span></div>
            <div class="gehc-bar__track" role="meter" aria-valuemin="0" aria-valuemax="${maxScale}" aria-valuenow="${val}">
              <span class="gehc-bar__fill" style="width:${pct}%"></span>
              <span class="gehc-bar__value">${val}</span>
            </div>
          </div>`;
      }).join('');
      singleContent.innerHTML = `
        <div style="display:grid;grid-template-columns:180px 1fr;gap:14px;align-items:start">
          <div>
            ${product.image ? `<img src="${product.image}" alt="${product.title}" style="width:100%;height:auto;border-radius:12px;background:#f1f5f9">` : ''}
          </div>
          <div>
            <h3 style="margin:.25rem 0 .5rem">${product.title}</h3>
            <div style="color:#111827;font-weight:600;margin-bottom:8px">${product.price || ''}</div>
            ${bars}
            <div style="margin-top:12px;display:flex;gap:8px">
              <a href="${product.url}" class="gehc-btn" style="text-decoration:none">View product</a>
            </div>
          </div>
        </div>`;
      openModal(modalSingle);
    }

    // Compare renderer
    function renderCompare(){
      const items = Array.from(selected.values());
      compareCountEl.textContent = items.length;
      compareCtaWrap.hidden = items.length === 0;
      if(!items.length) return;

      const cols = items.length;
      compareTable.style.setProperty('--cols', cols);

      const headCells = items.map(p=>`<div class="gehc-cell gehc-cell--head"><img class="gehc-thumb" src="${p.image || ''}" alt=""><div><div>${p.title}</div><div style="font-size:12px;color:#374151">${p.price || ''}</div></div></div>`).join('');
      const header = `<div class="gehc-row"><div></div>${headCells}</div>`;

      const rows = chars.map(c=>{
        const labelIcon = c.iconPath ? `<svg viewBox='0 0 24 24' width='18' height='18' fill='currentColor'><path d='${c.iconPath}'/></svg>` : `<svg viewBox='0 0 24 24' width='18' height='18' fill='currentColor'><circle cx='12' cy='12' r='6'/></svg>`;
        const cells = items.map(p=>{
          const v = Number(p.scores?.[c.key] || 0);
          const pct = Math.min(100, Math.round((v/maxScale)*100));
          return `<div class="gehc-cell"><div class="gehc-bar__track" aria-valuemin="0" aria-valuemax="${maxScale}" aria-valuenow="${v}"><span class="gehc-bar__fill" style="width:${pct}%"></span><span class="gehc-bar__value">${v}</span></div></div>`;
        }).join('');
        return `<div class="gehc-row"><div class="gehc-row__label"><span class="gehc-icon">${labelIcon}</span>${c.label}</div>${cells}</div>`;
      }).join('');

      compareTable.innerHTML = header + rows;
      openModal(modalCompare);
    }

    // Wire up cards
    root.querySelectorAll('[data-product]').forEach(card=>{
      const data = productFromCard(card);
      if(!data) return;
      const btnQuick = card.querySelector('[data-quick-chart]');
      btnQuick?.addEventListener('click', ()=>renderSingle(data));

      const cb = card.querySelector('[data-compare-toggle]');
      cb?.addEventListener('change', (e)=>{
        if(e.target.checked){ selected.set(data.id, data); }
        else { selected.delete(data.id); }
        compareCountEl.textContent = selected.size;
        compareCtaWrap.hidden = selected.size === 0;
      });
    });

    // Compare actions
    root.querySelector('[data-compare-open]')?.addEventListener('click', renderCompare);
    root.querySelector('[data-compare-clear]')?.addEventListener('click', ()=>{
      selected.clear();
      root.querySelectorAll('[data-compare-toggle]').forEach(cb=>cb.checked=false);
      compareCountEl.textContent = 0;
      compareCtaWrap.hidden = true;
    });

    // Modal close
    root.querySelectorAll('[data-modal-close]').forEach(btn=>{
      btn.addEventListener('click', ()=> closeModal(btn.closest('dialog')));
    });

    // Close on backdrop click
    [modalSingle, modalCompare].forEach(dlg=>{
      if(!dlg) return;
      dlg.addEventListener('click', (e)=>{ if(e.target === dlg) closeModal(dlg); });
    });
  })();
</script>

{% schema %}
{
  "name": "GE Helmet Compare",
  "settings": [
    {"type":"text","id":"heading","label":"Heading","default":"Find your helmet: compare what matters"},
    {"type":"text","id":"subheading","label":"Subheading","default":"Pick a few helmets and open the chart to see ventilation, protection, comfort and more."},
    {"type":"range","id":"max_scale","label":"Max scale (bars)","min":3,"max":10,"step":1,"default":5},
    {"type":"checkbox","id":"show_disclosure","label":"Show trademark license disclosure","default":true},
    {"type":"text","id":"disclosure_text","label":"Disclosure text","default":"GE is a trademark of General Electric Company. Used under trademark license."}
  ],
  "blocks": [
    {
      "type":"product",
      "name":"Helmet",
      "limit": 24,
      "settings": [
        {"type":"product","id":"product","label":"Select product"}
      ]
    },
    {
      "type":"characteristic",
      "name":"Characteristic",
      "limit": 20,
      "settings": [
        {"type":"text","id":"key","label":"Key (metafield name, e.g., ventilation)","default":"ventilation"},
        {"type":"text","id":"label","label":"Label (shown to users)","default":"Ventilation"},
        {"type":"text","id":"icon_path","label":"SVG path (optional)","info":"Paste an SVG <path d=\"...\"> value. Leave blank for a default dot icon."}
      ]
    }
  ],
  "presets": [
    {
      "name": "GE Helmet Compare",
      "blocks": [
        {"type":"characteristic","settings":{"key":"ventilation","label":"Ventilation","icon_path":"M12 2v20M2 12h20"}},
        {"type":"characteristic","settings":{"key":"sun_protection","label":"Sun protection","icon_path":"M6.76 4.84l-1.8-1.79M17.24 19.16l1.8 1.8M1 12h3M20 12h3M12 1v3M12 20v3M4.22 19.78l2.12-2.12M17.66 6.34l2.12-2.12M12 8a4 4 0 110 8 4 4 0 010-8z"}},
        {"type":"characteristic","settings":{"key":"impact_protection","label":"Impact protection","icon_path":"M12 2l9 4v6c0 5-4 9-9 10-5-1-9-5-9-10V6l9-4z"}},
        {"type":"characteristic","settings":{"key":"heat_protection","label":"Heat protection","icon_path":"M12 2s4 4 0 8 0 8 0 8-4-4 0-8 0-8 0-8z"}},
        {"type":"characteristic","settings":{"key":"warranty","label":"Warranty","icon_path":"M12 2l7 3v6c0 4.97-3.58 9.23-8.5 10-4.92-.77-8.5-5.03-8.5-10V5l10-3z"}},
        {"type":"characteristic","settings":{"key":"customization","label":"Customization","icon_path":"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z"}},
        {"type":"characteristic","settings":{"key":"lightweight","label":"Lightweight","icon_path":"M2 12s4-6 10-6 10 6 10 6-4 6-10 6S2 12 2 12z"}},
        {"type":"characteristic","settings":{"key":"comfort","label":"Comfort","icon_path":"M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 6 4 4 6.5 4 8 4 9.5 4.8 10.5 6c1-1.2 2.5-2 4-2C17 4 19 6 19 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"}},
        {"type":"characteristic","settings":{"key":"design","label":"Design","icon_path":"M3 3h18v2H3V3zm2 4h14l-2 10H7L5 7zm5 12h4v2h-4v-2z"}}
      ]
    }
  ]
}
{% endschema %}
