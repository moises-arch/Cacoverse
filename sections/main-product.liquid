{% assign product_form_id = 'pdp-product-form-' | append: section.id %}
{% assign initial_variant = product.selected_or_first_available_variant %}
{% assign initial_sale = 0 %}
{% if initial_variant.compare_at_price > initial_variant.price %}
  {% assign initial_sale = 100 | times: initial_variant.compare_at_price | divided_by: initial_variant.compare_at_price | minus: 100 | plus: 0 %}
{% endif %}

<section id="MainProduct-{{ section.id }}" class="pdp-section" style="padding: {{ section.settings.padding_top | default: 28 }}px 0 {{ section.settings.padding_bottom | default: 28 }}px;">
  {{ 'pdp.css' | asset_url | stylesheet_tag }}

  <div
    class="pdp"
    data-section-id="{{ section.id }}"
    data-product-id="{{ product.id }}"
    data-money-format='{{ shop.money_format | json }}'
    data-text-add="{{ 'products.product.add_to_cart' | t | escape }}"
    data-text-soldout="{{ 'products.product.sold_out' | t | escape }}"
    data-text-instock="{{ 'products.product.inventory_in_stock' | t | escape }}"
    data-text-lowstock="{{ 'products.product.inventory_low_stock_show_count' | t: quantity: 1 | escape }}"
  >
    <div class="pdp__layout">
      <div class="pdp__media">
        <div class="pdp__media-viewer" data-media-viewer>
          {% assign featured_media = initial_variant.featured_media | default: product.media.first %}
          {% if featured_media %}
            <img
              src="{{ featured_media | image_url: width: 1200 }}"
              alt="{{ featured_media.alt | default: product.title | escape }}"
              loading="eager"
              data-active-media-id="{{ featured_media.id }}"
            >
          {% else %}
            <div class="pdp__media-placeholder" aria-hidden="true"></div>
          {% endif %}
        </div>

        {% if product.media.size > 1 %}
          <div class="pdp__thumbs" role="list">
            {% for media in product.media %}
              {% assign media_variant_ids = product.variants | where: 'featured_media.id', media.id | map: 'id' %}
              <button
                type="button"
                class="pdp__thumb{% if featured_media and featured_media.id == media.id %} is-active{% endif %}"
                data-media-thumb
                data-media-id="{{ media.id }}"
                data-media-type="{{ media.media_type }}"
                data-media-src="{{ media | image_url: width: 1400 }}"
                data-variant-ids="{{ media_variant_ids | join: ',' }}"
                aria-label="{{ 'products.product.media.toggle_expand' | t }}"
                role="listitem"
              >
                <img src="{{ media | image_url: width: 240 }}" alt="{{ media.alt | default: product.title | escape }}" loading="lazy">
              </button>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <div class="pdp__info">
        {% if product.vendor != blank %}
          <p class="pdp__eyebrow">{{ product.vendor }}</p>
        {% endif %}
        <h1 class="pdp__title">{{ product.title | escape }}</h1>
        {% if product.metafields.custom.sub_title != blank %}
          <p class="pdp__subtitle">{{ product.metafields.custom.sub_title }}</p>
        {% endif %}

        <div class="pdp__price-row" aria-live="polite">
          <div class="pdp__price" data-price>
            <span data-price-current>{{ initial_variant.price | money }}</span>
            <span data-price-compare{% unless initial_variant.compare_at_price > initial_variant.price %} style="display:none"{% endunless %}>{{ initial_variant.compare_at_price | money }}</span>
            <span class="pdp__badge pdp__badge--sale" data-price-sale></span>
            <span class="pdp__badge pdp__badge--soldout" data-price-soldout{% if initial_variant.available %} style="display:none"{% endif %}>{{ 'products.product.sold_out' | t }}</span>
          </div>
          <div class="pdp__stock" data-stock>
            {% if initial_variant.available %}
              {% if initial_variant.inventory_management == 'shopify' and initial_variant.inventory_quantity <= 5 and initial_variant.inventory_quantity > 0 %}
                {{ 'products.product.inventory_low_stock_show_count' | t: quantity: initial_variant.inventory_quantity }}
              {% else %}
                {{ 'products.product.inventory_in_stock' | t }}
              {% endif %}
            {% else %}
              {{ 'products.product.inventory_out_of_stock' | t }}
            {% endif %}
          </div>
        </div>

        {% form 'product', product, id: product_form_id, class: 'pdp__form', novalidate: 'novalidate' %}
          <input type="hidden" name="id" value="{{ initial_variant.id }}">
          <input type="hidden" name="form_type" value="product">
          <input type="hidden" name="utf8" value="✓">

          {% unless product.has_only_default_variant %}
            <div class="pdp__options" data-options>
              {% for option in product.options_with_values %}
                {% assign is_color = option.name | downcase | contains: 'color' %}
                <div class="pdp__option" data-option-index="{{ forloop.index0 }}">
                  <div class="pdp__option-name">
                    {{ option.name }}
                    <span class="pdp__option-value" data-option-value="{{ forloop.index0 }}">{{ option.selected_value }}</span>
                  </div>
                  <div class="pdp__choices" role="radiogroup" aria-label="{{ option.name }}">
                    {% for value in option.values %}
                      {% assign input_id = 'Option-' | append: section.id | append: '-' | append: option.position | append: '-' | append: forloop.index %}
                      <input
                        type="radio"
                        id="{{ input_id }}"
                        name="options[{{ option.name | escape }}]"
                        value="{{ value | escape }}"
                        {% if option.selected_value == value %}checked{% endif %}
                      >
                      <label
                        class="pdp__choice{% if is_color %} pdp__choice--swatch{% endif %}"
                        for="{{ input_id }}"
                        {% if is_color %}style="--swatch-color: {{ value | escape }};"{% endif %}
                      >
                        {% if is_color %}
                          <span class="pdp__swatch-circle" aria-hidden="true"></span>
                          <span class="pdp__choice-text">{{ value }}</span>
                        {% else %}
                          {{ value }}
                        {% endif %}
                      </label>
                    {% endfor %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% endunless %}

          <div class="pdp__meta">
            {% if initial_variant.sku != blank %}
              <span class="pdp__sku-label">{{ 'products.product.sku' | t }}:</span>
              <span class="pdp__sku-value" data-sku>{{ initial_variant.sku }}</span>
            {% endif %}
          </div>

          <div class="pdp__cta-row">
            <label class="pdp__qty" aria-label="{{ 'products.product.quantity.label' | t }}">
              <span class="pdp__qty-label">{{ 'products.product.quantity.label' | t }}</span>
              <div class="pdp__qty-control">
                <button type="button" class="pdp__qty-btn" data-qty-minus aria-label="{{ 'products.product.quantity.decrease' | t }}"><span aria-hidden="true">−</span></button>
                <input
                  type="number"
                  name="quantity"
                  min="{{ initial_variant.quantity_rule.min | default: 1 }}"
                  step="{{ initial_variant.quantity_rule.increment | default: 1 }}"
                  value="{{ initial_variant.quantity_rule.min | default: 1 }}"
                  {% if initial_variant.quantity_rule.max > 0 %}
                    max="{{ initial_variant.quantity_rule.max }}"
                  {% endif %}
                >
                <button type="button" class="pdp__qty-btn" data-qty-plus aria-label="{{ 'products.product.quantity.increase' | t }}"><span aria-hidden="true">+</span></button>
              </div>
            </label>
            <button type="submit" name="add" class="pdp__btn" data-add-to-cart>
              <span data-add-to-cart-text>
                {% if initial_variant.available %}
                  {{ 'products.product.add_to_cart' | t }}
                {% else %}
                  {{ 'products.product.sold_out' | t }}
                {% endif %}
              </span>
            </button>
          </div>

          <div class="pdp__payments">{{ form | payment_terms }}</div>
        {% endform %}

        {% if product.description != blank %}
          <div class="pdp__description">
            <h2 class="pdp__description-title">{{ 'products.product.product_description' | t }}</h2>
            <div class="pdp__description-body rte">
              {{ product.description }}
            </div>
          </div>
        {% endif %}
      </div>
    </div>

    <script type="application/json" id="pdp-product-{{ section.id }}">{{ product | json }}</script>
  </div>

  <script src="{{ 'pdp.js' | asset_url }}" defer></script>
</section>

{% schema %}
{
  "name": "Main product",
  "settings": [
    {
      "type": "range",
      "id": "padding_top",
      "label": "Top padding",
      "min": 0,
      "max": 80,
      "step": 4,
      "default": 28
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Bottom padding",
      "min": 0,
      "max": 80,
      "step": 4,
      "default": 28
    }
  ],
  "presets": [
    {
      "name": "Main product"
    }
  ]
}
{% endschema %}
